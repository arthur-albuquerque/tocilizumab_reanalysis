---
title: "05_Sensitivity_Analyses_Different_Priors"
author: "Arthur M. Albuquerque"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
          toc: yes
          toc_float: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message=FALSE, warning=FALSE}
# Ensures the package "pacman" is installed
if (!require("pacman")) install.packages("pacman")

# p_load() installs (if necessary) and loads the following packages

pacman::p_load(tidyverse, # Data wrangling and plotting
               here, # File paths
               ggdist, # To plot distributions
               kableExtra, # To create nice tables
               gt, # To create nice tables
               rcartocolor, # Color pallete
               PNWColors,  # Color pallete
               patchwork # To add arrows
)
```

```{r}
## Load posterior distributions' samples with logOR, OR and RD

# I uploaded these data objects to OSF since the .RData file is 54MB.
# Here I load all data files directly from OSF without having to download it
# to my/your PC

samples = url("https://osf.io/3qexw/download?version=1")
load(gzcon(samples))

# In case you have downloaded the file above from OSF, you can run the following
# function to load the .RData file from your computer
# load(file = here("02_preprint", "output",  "data", "analyses", # file path
#                     "samples_posteriors_death.RData"))

## Load objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

load(file = here("02_preprint", "output", "data", "analyses", # file path
                 "data_prior_posteriors_mean_sd_death.RData"))   # file name
```

```{r}
set.seed = 123 # set seed for reproducibility
```


**In this document, we will present results on sensitivity analyses using different priors on the mortality outcome. Thus, we break down Figure 3 and Supplementary Figure 1.**

# Use of corticosteroids

## Not using

### Prior and likelihood distributions

```{r}

distributions =
  tibble(
    
    "RECOVERY (likelihood)" = list(
      rnorm(
        10e4,
        mean = (posteriors_not_using_death %>%
                # Data.mean and data.sd are all the same in every row
                # So it doesn't matter what row I slice
                slice(1) %>% 
                pull(data.mean)),
        sd = (posteriors_not_using_death %>%
              slice(1) %>% 
              pull(data.sd))
    )),
    
    "Non-informative prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_not_using_death %>%
                filter(type == "non-informative") %>%
                pull(prior.mean)),
        sd = (posteriors_not_using_death %>%
              filter(type == "non-informative") %>%
              pull(prior.sd))
    )),
    
    "Evidence-based prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_not_using_death %>%
                filter(type == "evidence-based") %>%
                pull(prior.mean)),
        sd = (posteriors_not_using_death %>%
              filter(type == "evidence-based") %>%
              pull(prior.sd))
    )),
    
    "Skeptical prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_not_using_death %>%
                filter(type == "skeptical") %>%
                pull(prior.mean)),
        sd = (posteriors_not_using_death %>%
              filter(type == "skeptical") %>%
              pull(prior.sd))
    )),
    
    "Optimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_not_using_death %>%
                filter(type == "optimistic") %>%
                pull(prior.mean)),
        sd = (posteriors_not_using_death %>%
              filter(type == "optimistic") %>%
              pull(prior.sd))
    )),
    
    "Pessimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_not_using_death %>%
                filter(type == "pessimistic") %>%
                pull(prior.mean)),
        sd = (posteriors_not_using_death %>%
              filter(type == "pessimistic") %>%
              pull(prior.sd))
    ))
  ) %>% 
  unnest(everything())

    
```


```{r, fig.height=5.5, fig.width = 5.5, fig.align='center'}

# Plot!

not_using_priors = 
  distributions %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(everything()),
    names_to = "dist", values_to = "samples"
  ) %>%
  # Set order of priors
  mutate(dist = factor(dist, levels =
                         c("RECOVERY (likelihood)",
                           "Non-informative prior",
                           "Evidence-based prior",
                           "Skeptical prior",
                           "Optimistic prior",
                           "Pessimistic prior")
                       )
         ) %>%
  # exp() to transform log(OR) to OR
  ggplot(aes(
    x = exp(samples), y = dist,
    fill = dist
  )) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(position = "dodge",
               point_interval = median_qi, # Quantile interval 
               .width = c(0.95)) +
  geom_vline(xintercept = 1, linetype = 2, size = 0.6) +
  
  # https://github.com/jakelawlor/PNWColors#palettes
  scale_fill_manual(values = pnw_palette("Sailboat", n=6)) +
  
  labs(
    x = "\nOdds Ratio",
    y = " "
  ) +
  scale_x_continuous(breaks = seq(from = 0, to = 2.5, 0.5)) +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'none',
    legend.text = element_text(size=12),
    legend.key= element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  ) +
  coord_cartesian(x = c(0, 2.5)) +
  facet_wrap(~dist, ncol = 1, scales = "free_y")

not_using_priors
  
```

### Posterior distributions

```{r, , fig.align='center', fig.width=7, fig.height = 4.5, fig.cap="Point estimates depict the median. Interval bars depict the 80 and 95% highest density intervals."}

# Prepare arrows under axis
# Adapted from https://github.com/rdboyes/forester/blob/master/R/forester.R


arrow_labels = c("Tocilizumab Harm", "Tocilizumab Benefit")

xlim = c(0, 20)

xlab_df = data.frame(text = arrow_labels,
                          x = c(2,18),
                          y = c(0, 0),
                          hjust = c(0, 1))

a_small_amount = abs(xlim[1] - xlim[2])/35

null_line_at = 10

arrow_df = data.frame(id = c(1,2),
                      xstart = c(null_line_at - a_small_amount,
                                      null_line_at + a_small_amount),
                      xend = c(xlim[1] + a_small_amount, xlim[2] - a_small_amount),
                      y = c(1, 1))

arrows_plot = ggplot() +
      geom_segment(data = arrow_df,
                   aes(x = .data$xstart,
                       xend = .data$xend,
                       y = .data$y,
                       yend = .data$y),
                   arrow = arrow(angle = 15, type = "closed", length = grid::unit(0.1, "in"))) +
  geom_text(data = xlab_df,
            aes(x = .data$x,
                y = .data$y,
                label = .data$text,
                hjust = .data$hjust), size = 3.5) +
  scale_y_continuous(expand = c(0,0), limits = c(-0.5, 1.75)) +
  scale_x_continuous(expand = c(0,0), limits = xlim) +
  theme(panel.background = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.box.background = element_rect(fill = "transparent"),
        panel.border = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank())

level_order = c("Pessimistic",
                "Optimistic",
                "Skeptical",
                "Non-informative",
                "Evidence-based")

p1 = samples_posteriors_not_using_death %>%
  
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = 100 * RD,
    y = factor(`Underlying_Prior`, level = level_order),
    fill = `Underlying_Prior`)) +
  geom_vline(xintercept = seq(-12.5, 12.5, 2.5), linetype = 1, size = 0.3,
             color = "gray80") +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
    stat_halfeye(aes(fill = stat(x > 0)),
                 position = "dodge",
               point_interval = median_hdi, # Highest density interval
               .width = c(0.8, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(1.1,1.9)
  ) +
  scale_fill_manual(values = c("gray85", "#516F88")) +
  labs(x = "\nRisk Difference (%)",
       y = "Underlying Prior\n"
  ) +
  scale_x_continuous(breaks = seq(from = -15, to = 15, 5)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 13.5),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(20, 25, 40, 20)
  ) +
  coord_cartesian(xlim = c(-15, 15))

p1_overlay = p1 + inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(4.8, 'cm'),
                                bottom = unit(0, 'cm'),
                                right = unit(16.8, 'cm'),
                                top = unit(1.6, 'cm'))

p1_overlay
```

<br><br>


```{r}

t = tibble(
  
  "Underlying Prior" = c(
    "Non-informative",
    "Evidence-based",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ),
  
  
  "Pr(< -5%)" = c(round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -2%)" = c(round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -1%)" = c(round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_not_using_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100
  ),
  
  
  "Pr(> 0%)" = c(round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 1%)" = c(round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 2%)" = c(round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 5%)" = c(round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_not_using_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100
  )
) 

# https://stackoverflow.com/questions/26548495/reorder-rows-using-custom-order

level_order = c("Evidence-based",
                "Non-informative",
                "Skeptical",
                "Optimistic",
                "Pessimistic"
                )

t = t %>% 
  slice(match(level_order, `Underlying Prior`))


```

### HDI for each posterior distribution

Here are the 95% HDI in *risk difference* of each distribution.

```{r}
multiply100 = function(x){x*100}

t1 = samples_posteriors_not_using_death %>%
  select("Underlying_Prior", "RD") %>% 
  # Group by distribution so we can apply median_hdi
  group_by(`Underlying_Prior`) %>% 
  # Calculate the median and 95% HDI
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  # Arrange order
  arrange(factor(`Underlying_Prior`, levels = c(
    "Evidence-based",
    "Non-informative",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
    ))) %>% 
  select("Underlying_Prior":.upper) %>%
  mutate(across(RD:.upper, ~multiply100(.))) %>%
  mutate(across(RD:.upper, ~round(., 2))) %>%
  rename("Underlying Prior" = Underlying_Prior,
         "Median" = RD,
         "Lower limit" = .lower,
         "Upper limit" = .upper) 

tfinal = left_join(t1, t)

tfinal = tfinal %>% 
  gt() %>% 
  tab_spanner(label = "95% HDI",
              columns = c(2:4)) %>% 
  tab_spanner(label = "Propability of Harm",
              columns = c("Pr(< -5%)", "Pr(< -2%)", "Pr(< -1%)")) %>% 
  tab_spanner(label = "Probability of Benefit",
              columns = c("Pr(> 0%)", "Pr(> 1%)", "Pr(> 2%)", "Pr(> 5%)")) %>%
  cols_align(
    align = "center",
    columns = everything()
  ) 
  

tfinal

```

## Using

### Prior and likelihood distributions

```{r}

distributions =
  tibble(
    
    "RECOVERY (likelihood)" = list(
      rnorm(
        10e4,
        mean = (posteriors_using_death %>%
                  # Data.mean and data.sd are all the same in every row
                  # So it doesn't matter what row I slice
                  slice(1) %>% 
                  pull(data.mean)),
        sd = (posteriors_using_death %>%
                slice(1) %>% 
                pull(data.sd))
      )),
    
    "Non-informative prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_using_death %>%
                  filter(type == "non-informative") %>%
                  pull(prior.mean)),
        sd = (posteriors_using_death %>%
                filter(type == "non-informative") %>%
                pull(prior.sd))
      )),
    
    "Evidence-based prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_using_death %>%
                  filter(type == "evidence-based") %>%
                  pull(prior.mean)),
        sd = (posteriors_using_death %>%
                filter(type == "evidence-based") %>%
                pull(prior.sd))
      )),
    
    "Skeptical prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_using_death %>%
                  filter(type == "skeptical") %>%
                  pull(prior.mean)),
        sd = (posteriors_using_death %>%
                filter(type == "skeptical") %>%
                pull(prior.sd))
      )),
    
    "Optimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_using_death %>%
                  filter(type == "optimistic") %>%
                  pull(prior.mean)),
        sd = (posteriors_using_death %>%
                filter(type == "optimistic") %>%
                pull(prior.sd))
      )),
    
    "Pessimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_using_death %>%
                  filter(type == "pessimistic") %>%
                  pull(prior.mean)),
        sd = (posteriors_using_death %>%
                filter(type == "pessimistic") %>%
                pull(prior.sd))
      ))
  ) %>% 
  unnest(everything())


```


```{r, fig.height=5.5, fig.width = 5.5, fig.align='center'}

# Plot!

using_priors = 
  distributions %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(everything()),
    names_to = "dist", values_to = "samples"
  ) %>%
  # Set order of priors
  mutate(dist = factor(dist, levels =
                         c("RECOVERY (likelihood)",
                           "Non-informative prior",
                           "Evidence-based prior",
                           "Skeptical prior",
                           "Optimistic prior",
                           "Pessimistic prior")
  )
  ) %>%
  # exp() to transform log(OR) to OR
  ggplot(aes(
    x = exp(samples), y = dist,
    fill = dist
  )) +
  
  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(position = "dodge",
               point_interval = median_qi, # Quantile interval 
               .width = c(0.95)) +
  geom_vline(xintercept = 1, linetype = 2, size = 0.6) +
  
  # https://github.com/jakelawlor/PNWColors#palettes
  scale_fill_manual(values = pnw_palette("Sailboat", n=6)) +
  
  labs(
    x = "\nOdds Ratio",
    y = " "
  ) +
  scale_x_continuous(breaks = seq(from = 0, to = 2.5, 0.5)) +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'none',
    legend.text = element_text(size=12),
    legend.key= element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  ) +
  coord_cartesian(x = c(0, 2.5)) +
  facet_wrap(~dist, ncol = 1, scales = "free_y")

using_priors

```

### Posterior distributions

```{r, , fig.align='center', fig.width=7, fig.height = 4.5, fig.cap="Point estimates depict the median. Interval bars depict the 80 and 95% highest density intervals."}

level_order = c("Pessimistic",
                "Optimistic",
                "Skeptical",
                "Non-informative",
                "Evidence-based"
                )

p1 = samples_posteriors_using_death %>%
  
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = 100 * RD,
    y = factor(`Underlying_Prior`, level = level_order),
    fill = `Underlying_Prior`)) +
  geom_vline(xintercept = seq(-12.5, 12.5, 2.5), linetype = 1, size = 0.3,
             color = "gray80") +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
    stat_halfeye(aes(fill = stat(x > 0)),
                 position = "dodge",
               point_interval = median_hdi, # Highest density interval
               .width = c(0.8, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(1.1,1.9)
  ) +
  scale_fill_manual(values = c("gray85", "#8DBEE9")) +
  labs(x = "\nRisk Difference (%)",
       y = "Underlying Prior\n"
  ) +
  scale_x_continuous(breaks = seq(from = -15, to = 15, 5)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 13.5),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(20, 25, 40, 20)
  ) +
  coord_cartesian(xlim = c(-15, 15))

p1_overlay = p1 + inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(4.8, 'cm'),
                                bottom = unit(0, 'cm'),
                                right = unit(16.8, 'cm'),
                                top = unit(1.6, 'cm'))

p1_overlay
```

<br><br>
  


```{r}

t = tibble(
  
  "Underlying Prior" = c(
    "Non-informative",
    "Evidence-based",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ),
  
  
  "Pr(< -5%)" = c(round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -2%)" = c(round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -1%)" = c(round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_using_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100
  ),
  
  
  "Pr(> 0%)" = c(round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 1%)" = c(round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 2%)" = c(round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 5%)" = c(round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_using_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100
  )
)

# https://stackoverflow.com/questions/26548495/reorder-rows-using-custom-order

level_order = c("Evidence-based",
                "Non-informative",
                "Skeptical",
                "Optimistic",
                "Pessimistic"
                )

t = t %>% 
  slice(match(level_order, `Underlying Prior`))


```

### HDI for each posterior distribution
  
Here are the 95% HDI in *risk difference* of each distribution.

```{r}
multiply100 = function(x){x*100}

t1 = samples_posteriors_using_death %>%
  select("Underlying_Prior", "RD") %>% 
  # Group by distribution so we can apply median_hdi
  group_by(`Underlying_Prior`) %>% 
  # Calculate the median and 95% HDI
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  # Arrange order
  arrange(factor(`Underlying_Prior`, levels = c(
    "Evidence-based",
    "Non-informative",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ))) %>% 
  select("Underlying_Prior":.upper) %>%
  mutate(across(RD:.upper, ~multiply100(.))) %>%
  mutate(across(RD:.upper, ~round(., 2))) %>%
  rename("Underlying Prior" = Underlying_Prior,
         "Median" = RD,
         "Lower limit" = .lower,
         "Upper limit" = .upper)

tfinal = left_join(t1, t)

tfinal = tfinal %>% 
  gt() %>% 
  tab_spanner(label = "95% HDI",
              columns = c(2:4)) %>% 
  tab_spanner(label = "Propability of Harm",
              columns = c("Pr(< -5%)", "Pr(< -2%)", "Pr(< -1%)")) %>% 
  tab_spanner(label = "Probability of Benefit",
              columns = c("Pr(> 0%)", "Pr(> 1%)", "Pr(> 2%)", "Pr(> 5%)")) %>%
  cols_align(
    align = "center",
    columns = everything()
  ) 
  

tfinal
```

# Respiratory support

## Simple oxygen only

### Prior and likelihood distributions

```{r}

distributions =
  tibble(
    
    "RECOVERY (likelihood)" = list(
      rnorm(
        10e4,
        mean = (posteriors_simple_death %>%
                  # Data.mean and data.sd are all the same in every row
                  # So it doesn't matter what row I slice
                  slice(1) %>% 
                  pull(data.mean)),
        sd = (posteriors_simple_death %>%
                slice(1) %>% 
                pull(data.sd))
      )),
    
    "Non-informative prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_simple_death %>%
                  filter(type == "non-informative") %>%
                  pull(prior.mean)),
        sd = (posteriors_simple_death %>%
                filter(type == "non-informative") %>%
                pull(prior.sd))
      )),
    
    "Evidence-based prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_simple_death %>%
                  filter(type == "evidence-based") %>%
                  pull(prior.mean)),
        sd = (posteriors_simple_death %>%
                filter(type == "evidence-based") %>%
                pull(prior.sd))
      )),
    
    "Skeptical prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_simple_death %>%
                  filter(type == "skeptical") %>%
                  pull(prior.mean)),
        sd = (posteriors_simple_death %>%
                filter(type == "skeptical") %>%
                pull(prior.sd))
      )),
    
    "Optimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_simple_death %>%
                  filter(type == "optimistic") %>%
                  pull(prior.mean)),
        sd = (posteriors_simple_death %>%
                filter(type == "optimistic") %>%
                pull(prior.sd))
      )),
    
    "Pessimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_simple_death %>%
                  filter(type == "pessimistic") %>%
                  pull(prior.mean)),
        sd = (posteriors_simple_death %>%
                filter(type == "pessimistic") %>%
                pull(prior.sd))
      ))
  ) %>% 
  unnest(everything())


```


```{r, fig.height=5.5, fig.width = 5.5, fig.align='center'}

# Plot!

simple_priors =
  distributions %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(everything()),
    names_to = "dist", values_to = "samples"
  ) %>%
  # Set order of priors
  mutate(dist = factor(dist, levels =
                         c("RECOVERY (likelihood)",
                           "Non-informative prior",
                           "Evidence-based prior",
                           "Skeptical prior",
                           "Optimistic prior",
                           "Pessimistic prior")
  )
  ) %>%
  # exp() to transform log(OR) to OR
  ggplot(aes(
    x = exp(samples), y = dist,
    fill = dist
  )) +
  
  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(position = "dodge",
               point_interval = median_qi, # Quantile interval 
               .width = c(0.95)) +
  geom_vline(xintercept = 1, linetype = 2, size = 0.6) +
  
  # https://github.com/jakelawlor/PNWColors#palettes
  scale_fill_manual(values = pnw_palette("Sailboat", n=6)) +
  
  labs(
    x = "\nOdds Ratio",
    y = " "
  ) +
  scale_x_continuous(breaks = seq(from = 0, to = 4, 1)) +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'none',
    legend.text = element_text(size=12),
    legend.key= element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  ) +
  coord_cartesian(x = c(0, 4)) +
  facet_wrap(~dist, ncol = 1, scales = "free_y")

simple_priors

```

### Posterior distributions

```{r, , fig.align='center', fig.width=7, fig.height = 4.5, fig.cap="Point estimates depict the median. Interval bars depict the 80 and 95% highest density intervals."}

level_order = c("Pessimistic",
                "Optimistic",
                "Skeptical",
                "Non-informative",
                "Evidence-based")

p1 = samples_posteriors_simple_death %>%
  
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = 100 * RD,
    y = factor(`Underlying_Prior`, level = level_order),
    fill = `Underlying_Prior`)) +
  geom_vline(xintercept = seq(-12.5, 12.5, 2.5), linetype = 1, size = 0.3,
             color = "gray80") +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
    stat_halfeye(aes(fill = stat(x > 0)),
                 position = "dodge",
               point_interval = median_hdi, # Highest density interval
               .width = c(0.8, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(1.1,1.9)
  ) +
  scale_fill_manual(values = c("gray85", "#EECE9C")) +
  labs(x = "\nRisk Difference (%)",
       y = "Underlying Prior\n"
  ) +
  scale_x_continuous(breaks = seq(from = -15, to = 15, 5)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 13.5),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(20, 25, 40, 20)
  ) +
  coord_cartesian(xlim = c(-15, 15))

p1_overlay = p1 + inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(4.8, 'cm'),
                                bottom = unit(0, 'cm'),
                                right = unit(16.8, 'cm'),
                                top = unit(1.6, 'cm'))

p1_overlay
```

<br><br>

```{r}

t = tibble(
  
  "Underlying Prior" = c(
    "Non-informative",
    "Evidence-based",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ),
  
  
  "Pr(< -5%)" = c(round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -2%)" = c(round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -1%)" = c(round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_simple_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100
  ),
  
  
  "Pr(> 0%)" = c(round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 1%)" = c(round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 2%)" = c(round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 5%)" = c(round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_simple_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100
  )
) 

# https://stackoverflow.com/questions/26548495/reorder-rows-using-custom-order

level_order = c("Evidence-based",
                "Non-informative",
                "Skeptical",
                "Optimistic",
                "Pessimistic"
                )

t = t %>% 
  slice(match(level_order, `Underlying Prior`))


```

### HDI for each posterior distribution

Here are the 95% HDI in *risk difference* of each distribution.

```{r}
multiply100 = function(x){x*100}

t1 = samples_posteriors_simple_death %>%
  select("Underlying_Prior", "RD") %>% 
  # Group by distribution so we can apply median_hdi
  group_by(`Underlying_Prior`) %>% 
  # Calculate the median and 95% HDI
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  # Arrange order
  arrange(factor(`Underlying_Prior`, levels = c(
    "Evidence-based",
    "Non-informative",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ))) %>% 
  select("Underlying_Prior":.upper) %>%
  mutate(across(RD:.upper, ~multiply100(.))) %>%
  mutate(across(RD:.upper, ~round(., 2))) %>%
  rename("Underlying Prior" = Underlying_Prior,
         "Median" = RD,
         "Lower limit" = .lower,
         "Upper limit" = .upper)

tfinal = left_join(t1, t)

tfinal = tfinal %>% 
  gt() %>% 
  tab_spanner(label = "95% HDI",
              columns = c(2:4)) %>% 
  tab_spanner(label = "Propability of Harm",
              columns = c("Pr(< -5%)", "Pr(< -2%)", "Pr(< -1%)")) %>% 
  tab_spanner(label = "Probability of Benefit",
              columns = c("Pr(> 0%)", "Pr(> 1%)", "Pr(> 2%)", "Pr(> 5%)")) %>%
  cols_align(
    align = "center",
    columns = everything()
  )

tfinal


```

## Non-invasive ventilation

### Prior and likelihood distributions

```{r}

distributions =
  tibble(
    
    "RECOVERY (likelihood)" = list(
      rnorm(
        10e4,
        mean = (posteriors_noninvasive_death %>%
                  # Data.mean and data.sd are all the same in every row
                  # So it doesn't matter what row I slice
                  slice(1) %>% 
                  pull(data.mean)),
        sd = (posteriors_noninvasive_death %>%
                slice(1) %>% 
                pull(data.sd))
      )),
    
    "Non-informative prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_noninvasive_death %>%
                  filter(type == "non-informative") %>%
                  pull(prior.mean)),
        sd = (posteriors_noninvasive_death %>%
                filter(type == "non-informative") %>%
                pull(prior.sd))
      )),
    
    "Evidence-based prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_noninvasive_death %>%
                  filter(type == "evidence-based") %>%
                  pull(prior.mean)),
        sd = (posteriors_noninvasive_death %>%
                filter(type == "evidence-based") %>%
                pull(prior.sd))
      )),
    
    "Skeptical prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_noninvasive_death %>%
                  filter(type == "skeptical") %>%
                  pull(prior.mean)),
        sd = (posteriors_noninvasive_death %>%
                filter(type == "skeptical") %>%
                pull(prior.sd))
      )),
    
    "Optimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_noninvasive_death %>%
                  filter(type == "optimistic") %>%
                  pull(prior.mean)),
        sd = (posteriors_noninvasive_death %>%
                filter(type == "optimistic") %>%
                pull(prior.sd))
      )),
    
    "Pessimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_noninvasive_death %>%
                  filter(type == "pessimistic") %>%
                  pull(prior.mean)),
        sd = (posteriors_noninvasive_death %>%
                filter(type == "pessimistic") %>%
                pull(prior.sd))
      ))
  ) %>% 
  unnest(everything())


```


```{r, fig.height=5.5, fig.width = 5.5, fig.align='center'}

# Plot!

noninvasive_priors = 
  distributions %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(everything()),
    names_to = "dist", values_to = "samples"
  ) %>%
  # Set order of priors
  mutate(dist = factor(dist, levels =
                         c("RECOVERY (likelihood)",
                           "Non-informative prior",
                           "Evidence-based prior",
                           "Skeptical prior",
                           "Optimistic prior",
                           "Pessimistic prior")
  )
  ) %>%
  # exp() to transform log(OR) to OR
  ggplot(aes(
    x = exp(samples), y = dist,
    fill = dist
  )) +
  
  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(position = "dodge",
               point_interval = median_qi, # Quantile interval 
               .width = c(0.95)) +
  geom_vline(xintercept = 1, linetype = 2, size = 0.6) +
  
  # https://github.com/jakelawlor/PNWColors#palettes
  scale_fill_manual(values = pnw_palette("Sailboat", n=6)) +
  
  labs(
    x = "\nOdds Ratio",
    y = " "
  ) +
  scale_x_continuous(breaks = seq(from = 0, to = 2.5, 0.5)) +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'none',
    legend.text = element_text(size=12),
    legend.key= element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  ) +
  coord_cartesian(x = c(0, 2.5)) +
  facet_wrap(~dist, ncol = 1, scales = "free_y")

noninvasive_priors

```

### Posterior distributions

```{r, , fig.align='center', fig.width=7, fig.height = 4.5, fig.cap="Point estimates depict the median. Interval bars depict the 80 and 95% highest density intervals."}

level_order = c("Pessimistic",
                "Optimistic",
                "Skeptical",
                "Non-informative",
                "Evidence-based")

p1 = samples_posteriors_noninvasive_death %>%
  
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = 100 * RD,
    y = factor(`Underlying_Prior`, level = level_order),
    fill = `Underlying_Prior`)) +
  geom_vline(xintercept = seq(-12.5, 12.5, 2.5), linetype = 1, size = 0.3,
             color = "gray80") +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
    stat_halfeye(aes(fill = stat(x > 0)),
                 position = "dodge",
               point_interval = median_hdi, # Highest density interval
               .width = c(0.8, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(1.1,1.9)
  ) +
  scale_fill_manual(values = c("gray85", "#BE6376")) +
  labs(x = "\nRisk Difference (%)",
       y = "Underlying Prior\n"
  ) +
scale_x_continuous(breaks = seq(from = -15, to = 15, 5)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 13.5),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(20, 25, 40, 20)
  ) +
  coord_cartesian(xlim = c(-15, 15))

p1_overlay = p1 + inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(4.8, 'cm'),
                                bottom = unit(0, 'cm'),
                                right = unit(16.8, 'cm'),
                                top = unit(1.6, 'cm'))

p1_overlay
```

<br><br>
  

```{r}

t = tibble(
  
  "Underlying Prior" = c(
    "Non-informative",
    "Evidence-based",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ),
  
  
  "Pr(< -5%)" = c(round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -2%)" = c(round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -1%)" = c(round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_noninvasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100
  ),
  
  
  "Pr(> 0%)" = c(round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 1%)" = c(round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 2%)" = c(round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 5%)" = c(round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_noninvasive_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100
  )
)

# https://stackoverflow.com/questions/26548495/reorder-rows-using-custom-order

level_order = c("Evidence-based",
                "Non-informative",
                "Skeptical",
                "Optimistic",
                "Pessimistic"
                )

t = t %>% 
  slice(match(level_order, `Underlying Prior`))


```

### HDI for each posterior distribution
  
Here are the 95% HDI in *risk difference* of each distribution.

```{r}
multiply100 = function(x){x*100}

t1 = samples_posteriors_noninvasive_death %>%
  select("Underlying_Prior", "RD") %>% 
  # Group by distribution so we can apply median_hdi
  group_by(`Underlying_Prior`) %>% 
  # Calculate the median and 95% HDI
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  # Arrange order
  arrange(factor(`Underlying_Prior`, levels = c(
    "Evidence-based",
    "Non-informative",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ))) %>% 
  select("Underlying_Prior":.upper) %>%
  mutate(across(RD:.upper, ~multiply100(.))) %>%
  mutate(across(RD:.upper, ~round(., 2))) %>%
  rename("Underlying Prior" = Underlying_Prior,
         "Median" = RD,
         "Lower limit" = .lower,
         "Upper limit" = .upper)

tfinal = left_join(t1, t)

tfinal = tfinal %>% 
  gt() %>% 
  tab_spanner(label = "95% HDI",
              columns = c(2:4)) %>% 
  tab_spanner(label = "Propability of Harm",
              columns = c("Pr(< -5%)", "Pr(< -2%)", "Pr(< -1%)")) %>% 
  tab_spanner(label = "Probability of Benefit",
              columns = c("Pr(> 0%)", "Pr(> 1%)", "Pr(> 2%)", "Pr(> 5%)")) %>%
  cols_align(
    align = "center",
    columns = everything()
  )

tfinal


```

## Invasive mechanical ventilation

### Prior and likelihood distributions

```{r}

distributions =
  tibble(
    
    "RECOVERY (likelihood)" = list(
      rnorm(
        10e4,
        mean = (posteriors_invasive_death %>%
                  # Data.mean and data.sd are all the same in every row
                  # So it doesn't matter what row I slice
                  slice(1) %>% 
                  pull(data.mean)),
        sd = (posteriors_invasive_death %>%
                slice(1) %>% 
                pull(data.sd))
      )),
    
    "Non-informative prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_invasive_death %>%
                  filter(type == "non-informative") %>%
                  pull(prior.mean)),
        sd = (posteriors_invasive_death %>%
                filter(type == "non-informative") %>%
                pull(prior.sd))
      )),
    
    "Evidence-based prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_invasive_death %>%
                  filter(type == "evidence-based") %>%
                  pull(prior.mean)),
        sd = (posteriors_invasive_death %>%
                filter(type == "evidence-based") %>%
                pull(prior.sd))
      )),
    
    "Skeptical prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_invasive_death %>%
                  filter(type == "skeptical") %>%
                  pull(prior.mean)),
        sd = (posteriors_invasive_death %>%
                filter(type == "skeptical") %>%
                pull(prior.sd))
      )),
    
    "Optimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_invasive_death %>%
                  filter(type == "optimistic") %>%
                  pull(prior.mean)),
        sd = (posteriors_invasive_death %>%
                filter(type == "optimistic") %>%
                pull(prior.sd))
      )),
    
    "Pessimistic prior" = list(
      rnorm(
        10e4,
        mean = (posteriors_invasive_death %>%
                  filter(type == "pessimistic") %>%
                  pull(prior.mean)),
        sd = (posteriors_invasive_death %>%
                filter(type == "pessimistic") %>%
                pull(prior.sd))
      ))
  ) %>% 
  unnest(everything())


```


```{r, fig.height=5.5, fig.width = 5.5, fig.align='center'}

# Plot!

invasive_priors = 
  distributions %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(everything()),
    names_to = "dist", values_to = "samples"
  ) %>%
  # Set order of priors
  mutate(dist = factor(dist, levels =
                         c("RECOVERY (likelihood)",
                           "Non-informative prior",
                           "Evidence-based prior",
                           "Skeptical prior",
                           "Optimistic prior",
                           "Pessimistic prior")
  )
  ) %>%
  # exp() to transform log(OR) to OR
  ggplot(aes(
    x = exp(samples), y = dist,
    fill = dist
  )) +
  
  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(position = "dodge",
               point_interval = median_qi, # Quantile interval 
               .width = c(0.95)) +
  geom_vline(xintercept = 1, linetype = 2, size = 0.6) +
  
  # https://github.com/jakelawlor/PNWColors#palettes
  scale_fill_manual(values = pnw_palette("Sailboat", n=6)) +
  
  labs(
    x = "\nOdds Ratio",
    y = " "
  ) +
  scale_x_continuous(breaks = seq(from = 0, to = 2.5, 0.5)) +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'none',
    legend.text = element_text(size=12),
    legend.key= element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  ) +
  coord_cartesian(x = c(0, 2.5)) +
  facet_wrap(~dist, ncol = 1, scales = "free_y")

invasive_priors

```


### Posterior distributions

```{r, , fig.align='center', fig.width=7, fig.height = 4.5, fig.cap="Point estimates depict the median. Interval bars depict the 80 and 95% highest density intervals."}

level_order = c("Pessimistic",
                "Optimistic",
                "Skeptical",
                "Non-informative",
                "Evidence-based")

p1 = samples_posteriors_invasive_death %>%
  
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = 100 * RD,
    y = factor(`Underlying_Prior`, level = level_order),
    fill = `Underlying_Prior`)) +
  geom_vline(xintercept = seq(-12.5, 12.5, 2.5), linetype = 1, size = 0.3,
             color = "gray80") +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
    stat_halfeye(aes(fill = stat(x > 0)),
                 position = "dodge",
               point_interval = median_hdi, # Highest density interval
               .width = c(0.8, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(1.1,1.9)
  ) +
  scale_fill_manual(values = c("gray85", "#605A91")) +
  labs(x = "\nRisk Difference (%)",
       y = "Underlying Prior\n"
  ) +
scale_x_continuous(breaks = seq(from = -15, to = 15, 5)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 13.5),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(20, 25, 40, 20)
  ) +
  coord_cartesian(xlim = c(-15, 15))

p1_overlay = p1 + inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(4.8, 'cm'),
                                bottom = unit(0, 'cm'),
                                right = unit(16.8, 'cm'),
                                top = unit(1.6, 'cm'))

p1_overlay

```

<br><br>

```{r}

t = tibble(
  
  "Underlying Prior" = c(
    "Non-informative",
    "Evidence-based",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ),
  
  
  "Pr(< -5%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -2%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100
  ),
  
  "Pr(< -1%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100
  ),
  
  
  "Pr(> 0%)" = c(round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 1%)" = c(round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.01) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 2%)" = c(round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.02) / n()) %>%
                          pull()), 2) * 100
  ),
  
  "Pr(> 5%)" = c(round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Non-informative") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Evidence-based") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Skeptical") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Optimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100,
                 
                 round((samples_posteriors_invasive_death %>%
                          filter(`Underlying_Prior` == "Pessimistic") %>%
                          summarise(n = sum(RD > 0.05) / n()) %>%
                          pull()), 2) * 100
  )
)

# https://stackoverflow.com/questions/26548495/reorder-rows-using-custom-order

level_order = c("Evidence-based",
                "Non-informative",
                "Skeptical",
                "Optimistic",
                "Pessimistic"
                )

t = t %>% 
  slice(match(level_order, `Underlying Prior`))

```

### HDI for each posterior distribution
  
Here are the 95% HDI in *risk difference* of each distribution.

```{r}
multiply100 = function(x){x*100}

t1 = samples_posteriors_invasive_death %>%
  select("Underlying_Prior", "RD") %>% 
  # Group by distribution so we can apply median_hdi
  group_by(`Underlying_Prior`) %>% 
  # Calculate the median and 95% HDI
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  # Arrange order
  arrange(factor(`Underlying_Prior`, levels = c(
    "Evidence-based",
    "Non-informative",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ))) %>% 
  select("Underlying_Prior":.upper) %>%
  mutate(across(RD:.upper, ~multiply100(.))) %>%
  mutate(across(RD:.upper, ~round(., 2))) %>%
  rename("Underlying Prior" = Underlying_Prior,
         "Median" = RD,
         "Lower limit" = .lower,
         "Upper limit" = .upper)

tfinal = t1 %>% 
  gt() %>% 
  tab_spanner(label = "95% HDI",
              columns = c(2:4)) %>% 
  cols_align(
    align = "center",
    columns = everything()
  )

tfinal

```

```{r}
not_using = samples_posteriors_not_using_death %>% 
  mutate(subgroup = "Not using corticosteroids") %>% 
  select(subgroup, `Underlying_Prior`, RD)

using = samples_posteriors_using_death %>% 
  mutate(subgroup = "Using corticosteroids") %>% 
  select(subgroup, `Underlying_Prior`, RD)

simple = samples_posteriors_simple_death %>% 
  mutate(subgroup = "Simple oxygen only") %>% 
  select(subgroup, `Underlying_Prior`, RD)

noninvasive = samples_posteriors_noninvasive_death %>% 
  mutate(subgroup = "Non-invasive ventilation") %>% 
  select(subgroup, `Underlying_Prior`, RD)

invasive = samples_posteriors_invasive_death %>% 
  mutate(subgroup = "Invasive mechanical ventilation") %>% 
  select(subgroup, `Underlying_Prior`, RD)

altogether = bind_rows(not_using,
          using,
          simple,
          noninvasive,
          invasive)
```

```{r}
p1 = altogether %>% 
  filter(subgroup %in% c("Not using corticosteroids",
                         "Using corticosteroids")) %>% 
  # Define orders
  mutate(subgroup =
           factor(subgroup,
                  levels = c("Not using corticosteroids",
                             "Using corticosteroids")),
         `Underlying_Prior` =
           factor(`Underlying_Prior`,
                  levels = c("Pessimistic",
                             "Optimistic",
                             "Skeptical",
                             "Non-informative",
                             "Evidence-based"
                             )
                  )
         ) %>% 
  # Plot!
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = RD*100, y = `Underlying_Prior`,
    fill = subgroup,
    # https://github.com/mjskay/ggdist/issues/71
    fill_ramp = stat(x > 0))
  ) +
  
   geom_vline(xintercept = seq(-12.5, 12.5, 2.5), linetype = 1, size = 0.3,
             color = "gray80") +
   geom_vline(xintercept = 0, linetype = 2, size = 0.6) +
   # https://mjskay.github.io/ggdist/articles/slabinterval.html
    stat_halfeye(position = "dodge",
                 point_interval = median_hdi, # Highest density interval
                 .width = 0.95,
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(0.4,1)
  ) +
  scale_fill_ramp_discrete(from = "gray85", range = c(0,1)) +
  scale_fill_manual(values = c("#BB63A8", # Not using
                               "#66B5B9")) + # Using
  labs(x = "\nRisk Difference (%)",
       y = "Underlying Prior\n"
  ) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 13.5),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(20, 25, 40, 20)
  ) +
  scale_x_continuous(breaks = seq(from = -10, to = 10, 2.5))  +
  coord_cartesian(xlim = c(-12.5, 12.5)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  facet_wrap(~ subgroup, ncol = 1)
```

```{r}
p2 = altogether %>% 
  filter(subgroup %in% c("Simple oxygen only",
                         "Non-invasive ventilation",
                         "Invasive mechanical ventilation")) %>% 
  # Define orders
  mutate(subgroup =
           factor(subgroup,
                  levels = c("Simple oxygen only",
                             "Non-invasive ventilation",
                             "Invasive mechanical ventilation")),
         `Underlying_Prior` =
           factor(`Underlying_Prior`,
                  levels = c("Pessimistic",
                             "Optimistic",
                             "Skeptical",
                             "Non-informative",
                             "Evidence-based"
                             )
                  )
         ) %>% 
  # Plot!
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = RD*100, y = `Underlying_Prior`,
    fill = subgroup,
    # https://github.com/mjskay/ggdist/issues/71
    fill_ramp = stat(x > 0))
  ) +
  
   geom_vline(xintercept = seq(-12.5, 12.5, 2.5), linetype = 1, size = 0.3,
             color = "gray80") +
  geom_vline(xintercept = 0, linetype = 2, size = 0.6) +
  # https://mjskay.github.io/ggdist/articles/slabinterval.html
    stat_halfeye(position = "dodge",
                 point_interval = median_hdi, # Highest density interval
                 .width = c(0.94999, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(0.4,1)
  ) +
  scale_fill_ramp_discrete(from = "gray85", range = c(0,1)) +
  scale_fill_manual(values = c("#EECE9C", # Simple oxygen
                               "#DE8588", # Non-invasive
                               "#5A53A0") # Invasive 
                    ) + 
  labs(x = "\nRisk Difference (%)",
       y = " "
  ) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 13.5),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(20, 25, 40, 20)
  ) +
  scale_x_continuous(breaks = seq(from = -10, to = 10, 2.5))  +
  coord_cartesian(xlim = c(-12.5, 12.5)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  facet_wrap(~ subgroup, ncol = 1)
```



# Summary

## Supplementary Figure 1

```{r, fig.width = 12, fig.height=13}
(not_using_priors + using_priors) /
  (simple_priors + noninvasive_priors + invasive_priors) +
  plot_annotation(tag_levels = "A")

# ggsave(width = 12,
#        height = 13,
#        here("02_preprint", "output", "plots", "appendix", # File path
#                   "SFigure1_priors_sensitivity.pdf")) # File name
```

