---
title: "04_Posteriors"
author: "Arthur M. Albuquerque"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
          code_folding: hide
          toc: yes
          toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning, FALSE, echo = TRUE)
```

```{r include=FALSE}
library(tidyverse) # Data wrangling and plotting
library(flextable) # To create tables
library(tidybayes) # To plot distributions
library(ggdist) # To plot distributions
library(patchwork) # To arrange multiple plots
library(here) # To find file paths within R project
library(metafor) # To create priors from meta-analysis

# To generate beta distributions within tibbles

source(here("final_analyses", "script", "functions", # file path
            "beta_distributions.R"))                 # file name

# To plot to plot risk distributions side-by-side

source(here("final_analyses", "script", "functions", # file path
            "risk_comparison_plot.R"))               # file name

# To plot risk difference distribution

source(here("final_analyses", "script", "functions", # file path
            "risk_difference_plot.R"))               # file name

# To plot cumulative probability of risk difference

source(here("final_analyses", "script", "functions", # file path
            "cumulative_risk_difference_plot.R"))    # file name

# To generate normal conjugate posterior probabilities

source(here("final_analyses", "script", "functions", # file path
            "conjugate_normal_posterior.R"))         # file name

# To assist in the workflow of the function in "conjugate_normal_posterior.R"

source(here("final_analyses", "script", "functions", # file path
            "normal_approximation.R"))               # file name

# To plot prior, data and posterior distributions side-by-side

source(here("final_analyses", "script", "functions", # file path
            "data_prior_posterior_plot.R"))          # file name

# To plot the posterior distribution

source(here("final_analyses", "script", "functions", # file path
            "posterior_difference_plot.R"))          # file name

# To plot the cumulative probability of the posterior distribution

source(here("final_analyses", "script", "functions", # file path
            "posterior_cumulative_plot.R"))          # file name
```

```{r}
# Load data

d = read.csv((here("final_analyses", "output", "data", # file path
                   "respiratory-data.csv")),           # file name
             header = T)
d = d %>% 
  as_tibble() %>% 
  select(!starts_with("X")) %>% 
  
  # To create columns with the difference between sample size and events per arm
  # This will be useful while using Beta distributions,
  # diff = the Beta (b) parameter in a Beta distribution (a,b)
  mutate(diff_toci = total_toci - events_toci,
         diff_control = total_control - events_control)
```

Let's check again how many trials (other than RECOVERY) we have for each outcome
and subgroup

```{r}

d %>%
  filter(!str_detect(oxygen, "pooled"),
         trial != "RECOVERY") %>% 
  group_by(outcome, oxygen) %>%
  arrange(oxygen) %>%
  count() %>%
  rename("number of trials" = n) %>% 
  flextable() %>%
  autofit()

```

```{r}
### To create separate objects per subgroup
# Here I rename columns so these variables are usable in my beta_fun()

# Isolating RECOVERY
recovery_simple_oxygen = 
  d %>% 
  filter(trial == "RECOVERY",
         oxygen == "simple oxygen") %>% 
  
  # Only RECOVERY, so there is no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control")

recovery_non_invasive = 
  d %>% 
  filter(trial == "RECOVERY",
         oxygen == "non-invasive ventilation") %>% 
  
  # Only RECOVERY, so there is no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control") 

recovery_invasive = 
  d %>% 
  filter(trial == "RECOVERY",
         oxygen == "invasive ventilation") %>% 
  
  # Only RECOVERY, so there is no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control")

## Group all other trials per outcome and sum the events/sample size

trials_simple_oxygen =
  d %>% 
  filter(trial != "RECOVERY",
         oxygen == "simple oxygen") %>% 
  
  # Only COVACTA, so no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control")

trials_non_invasive = 
  d %>% 
  filter(trial != "RECOVERY",
         oxygen == "non-invasive ventilation") %>%
  group_by(outcome) %>% 
  summarise(sum_events_toci = sum(events_toci),
            sum_total_toci = sum(total_toci),
            sum_diff_toci = sum(diff_toci),
            sum_events_control = sum(events_control),
            sum_total_control = sum(total_control),
            sum_diff_control = sum(diff_control))

trials_invasive = 
  d %>% 
  filter(trial != "RECOVERY",
         oxygen == "invasive ventilation") %>%
  group_by(outcome) %>% 
  summarise(sum_events_toci = sum(events_toci),
            sum_total_toci = sum(total_toci),
            sum_diff_toci = sum(diff_toci),
            sum_events_control = sum(events_control),
            sum_total_control = sum(total_control),
            sum_diff_control = sum(diff_control))
```

# Mortality

**Regarding this outcome, negative risk differences mean benefit.**

<br>

## Using a non-informative prior
### Simple oxygen only

```{r, fig.align='center', fig.height=4, fig.width=7, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}

### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

n = 10e4 # To determine sampling size

# Here I use the uninformative_posterior_beta() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "beta_distributions.R")

beta_recovery_simple_oxygen = uniformative_posterior_beta( 
  recovery_simple_oxygen, # data
  "mortality" # outcome
) 

### Plot!

# I will use my own functions to standardize my plots

risk_comparison_plot(
  beta_recovery_simple_oxygen, # Data object

  ### start using quotes
  
  "gray50", # Color code for control group
  "#D3A464", # Color code for other group
  "\nRisk (%)", # X axis label
  "RECOVERY trial", # Title
  "Simple oxygen only subgroup\n", # Subtitle
  
  ### stop using quotes

  10, # X axis inferior limit
  30, # X axis superior limit
  2 # X axis spacing for ticks
)
```

```{r, fig.align='center', fig.height=4, fig.width=7}
xlabel = "\nRisk difference (%)"
xlim_inf = -10
xlim_sup = 5

p1 = risk_difference_plot(
  beta_recovery_simple_oxygen, # Data object

  ## start using quotes
  "#7EBAC2", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # X axis label
) 

p2 = cumulative_risk_difference_plot(
  beta_recovery_simple_oxygen, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  1, # Spacing between ticks in X axis
  "mortality" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is less than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "RECOVERY trial",
  subtitle = "Risk difference between groups on simple oxygen only"
)
```

### Non-invasive ventilation

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}

### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

n = 10e4 # To determine sampling size

# Here I use the uninformative_posterior_beta() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "beta_distributions.R")

beta_recovery_non_invasive = uniformative_posterior_beta( 
  recovery_non_invasive, # data
  "mortality" # outcome
) 

### Plot!

# I will be using my own functions to standardize my plots

risk_comparison_plot(
  beta_recovery_non_invasive, # Data object

  ### start using quotes
  
  "gray50", # Color code for control group
  "#D3A464", # Color code for other group
  "\nRisk (%)", # X axis label
  "RECOVERY trial", # Title
  "Non-invasive ventilation subgroup\n", # Subtitle
  
  ### stop using quotes

  28, # X axis inferior limit
  48, # X axis superior limit
  2 # Spacing between ticks in X axis
)
```

```{r}
xlabel = "\nRisk difference (%)"
xlim_inf = -12
xlim_sup = 5

p1 = risk_difference_plot(
  beta_recovery_non_invasive, # Data object

  ## start using quotes
  "#7EBAC2", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # Spacing between ticks in X axis
) 

p2 = cumulative_risk_difference_plot(
  beta_recovery_non_invasive, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  1, # Spacing between ticks in X axis
  "mortality" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is less than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "RECOVERY trial",
  subtitle = "Risk difference between groups on non-invasive ventilation"
)
```

### Invasive mechanical ventilation

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}

### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

n = 10e4 # To determine sampling size

# Here I use the uninformative_posterior_beta() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "beta_distributions.R")

beta_recovery_invasive = uniformative_posterior_beta( 
  recovery_invasive, # data
  "mortality" # outcome
) 

### Plot!

# I will be using my own functions to standardize my plots

risk_comparison_plot(
  beta_recovery_invasive, # Data object

  ### start using quotes
  
  "gray50", # Color code for control group
  "#D3A464", # Color code for other group
  "\nRisk (%)", # X axis label
  "RECOVERY trial", # Title
  "Invasive mechanical ventilation subgroup\n", # Subtitle
  
  ### stop using quotes

  36, # X axis inferior limit
  58, # X axis superior limit
  2 # Spacing between ticks in X axis
) + 
  
  # Extra function to better limits the axis in this case
  coord_cartesian(c(36, 58))
```

```{r}
xlabel = "\nRisk difference (%)"
xlim_inf = -16
xlim_sup = 12

p1 = risk_difference_plot(
  beta_recovery_invasive, # Data object

  ## start using quotes
  "#7EBAC2", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  4 # Spacing between ticks in X axis
) 

p2 = cumulative_risk_difference_plot(
  beta_recovery_invasive, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2, # Spacing between ticks in X axis
  "mortality" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is less than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "RECOVERY trial",
  subtitle = "Risk difference between groups on invasive mechanical ventilation"
)
```

## Using evidence-based priors

### Simple oxygen only

```{r, fig.align='center', fig.height=4, fig.width=5, warning=FALSE}

priors_simple_oxygen_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "simple oxygen"
  )

priors_simple_oxygen =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_simple_oxygen_raw %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_simple_oxygen)
```

```{r include=FALSE}
# Normal approximation function

recovery_simple_oxygen_normal = normal_approximation(
  recovery_simple_oxygen, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  priors_simple_oxygen, # Output from the rma() in the previous code chunk

  recovery_simple_oxygen_normal # Repeat the name of the object you are creating
)
  

```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}
set.seed = 123 # set seed for reproducibility (rnorm() function)
n = 10e4 # sampling size

xlabel = "\nRisk difference (%)"

data_prior_posterior_plot(
  recovery_simple_oxygen_normal, # Output from normal_approximation()
  
  # start using quotes
           "#364D55", # Color for the prior
           "#7EBAC2", # Color for RECOVERY
           "#A65041", # Color for the posterior
           xlabel, # X axis label
           "Posterior distribution: RECOVERY and previous evidence", # Title
           "Simple oxygen only subgroup", # Subtitle
           # stop using quotes
           -10, # X axis inferior limit
           20, # X axis superior limit
           5 # Spacing between ticks in X axis
  ) 

```

```{r}
xlim_inf = -8
xlim_sup = 4

p1 = posterior_difference_plot(
  recovery_simple_oxygen_normal, # Data object

  ## start using quotes
  "#A65041", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # Spacing between ticks in X axis
) 

p2 = posterior_cumulative_plot(
  recovery_simple_oxygen_normal, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  1, # Spacing between ticks in X axis
  "mortality" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is less than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "Posterior distribution: RECOVERY trial and previous evidence",
  subtitle = "Simple oxygen only subgroup"
)
```

### Non-invasive ventilation

```{r, fig.align='center', fig.height=4, fig.width=5}

priors_noninvasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "non-invasive ventilation"
  )

priors_noninvasive =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_noninvasive_raw %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_noninvasive)
```

```{r include=FALSE}
# Normal approximation function

recovery_noninvasive_normal = normal_approximation(
  recovery_non_invasive, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  priors_noninvasive, # Output from the rma() in the previous code chunk

  recovery_noninvasive_normal # Repeat the name of the object you are creating
)
  
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}
set.seed = 123 # set seed for reproducibility (rnorm() function)
n = 10e4 # sampling size

data_prior_posterior_plot(
  recovery_noninvasive_normal, # Output from normal_approximation()
  
  # start using quotes
           "#364D55", # Color for the prior
           "#7EBAC2", # Color for RECOVERY
           "#A65041", # Color for the posterior
           xlabel, # X axis label
           "Posterior distribution - RECOVERY and previous evidence", # Title
           "Non-invasive ventilation subgroup", # Subtitle
           # stop using quotes
           -15, # X axis inferior limit
           5, # X axis superior limit
           5 # Spacing between ticks in X axis
  ) 

```

```{r}
xlim_inf = -12
xlim_sup = 4

p1 = posterior_difference_plot(
  recovery_noninvasive_normal, # Data object

  ## start using quotes
  "#A65041", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # Spacing between ticks in X axis
) 

p2 = posterior_cumulative_plot(
  recovery_noninvasive_normal, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  1, # Spacing between ticks in X axis
  "mortality" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is less than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "Posterior distribution: RECOVERY trial and previous evidence",
  subtitle = "Non-invasive ventilation subgroup"
)
```

### Invasive mechanical ventilation
```{r, fig.align='center', fig.height=4, fig.width=5}

priors_invasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "invasive ventilation"
  )

priors_invasive =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_invasive_raw %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_invasive)
```

```{r include=FALSE}
# Normal approximation function

recovery_invasive_normal = normal_approximation(
  recovery_invasive, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  priors_invasive, # Object output from the rma() in the previous code chunk

  recovery_invasive_normal # Repeat the name of the object you are creating
)

```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}
set.seed = 123 # set seed for reproducibility (rnorm() function)
n = 10e4 # sampling size

data_prior_posterior_plot(
  recovery_invasive_normal, # Output from normal_approximation()
  
  # start using quotes
           "#364D55", # Color for the prior
           "#7EBAC2", # Color for RECOVERY
           "#A65041", # Color for the posterior
           xlabel, # X axis label
           "Posterior distribution - RECOVERY and previous evidence", # Title
           "Invasive mechanical ventilation subgroup", # Subtitle
           # stop using quotes
           -15, # X axis inferior limit
           10, # X axis superior limit
           5 # Spacing between ticks in X axis
  ) 

```

```{r}
xlabel = "\nRisk difference (%)"
xlim_inf = -12
xlim_sup = 8

p1 = posterior_difference_plot(
  recovery_invasive_normal, # Data object

  ## start using quotes
  "#A65041", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # Spacing between ticks in X axis
) 

p2 = posterior_cumulative_plot(
  recovery_invasive_normal, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2, # Spacing between ticks in X axis
  "mortality" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is less than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "Posterior distribution: RECOVERY trial and previous evidence",
  subtitle = "Invasive mechanical ventilation subgroup"
)
```

## Summary

```{r}
### Create variables for the summary plot

set.seed = 123 # set seed for reproducibility (rnorm())
n = 10e4 # sampling size


## Non-informative priors

delta_beta_recovery_simple_oxygen =
  beta_recovery_simple_oxygen %>%
  # Calculate difference between groups
  summarise("Simple oxygen only" = toci - control)

delta_beta_recovery_non_invasive =
  beta_recovery_non_invasive %>% 
  summarise("Non-invasive ventilation" = toci - control)

delta_beta_recovery_invasive =
  beta_recovery_invasive %>% 
  summarise("Invasive mechanical ventilation" = toci - control)

# Bind all 3 tibbles together
delta_noninformative = 
  delta_beta_recovery_simple_oxygen %>% 
  bind_cols(delta_beta_recovery_non_invasive, delta_beta_recovery_invasive)

## Evidence-based priors

delta_recovery_simple_oxygen_normal =
  recovery_simple_oxygen_normal %>%
  summarise("Simple oxygen only" = rnorm(n,
                                         mean = post.mean,
                                         sd = post.sd)
            )

delta_recovery_noninvasive_normal =
  recovery_noninvasive_normal %>%
  summarise("Non-invasive ventilation" = rnorm(n,
                                               mean = post.mean,
                                               sd = post.sd)
            )

delta_recovery_invasive_normal =
  recovery_invasive_normal %>%
  summarise("Invasive mechanical ventilation" = rnorm(n,
                                              mean = post.mean,
                                              sd = post.sd)
            )

# Bind all 3 tibbles together
delta_evidence = 
  delta_recovery_simple_oxygen_normal %>% 
  bind_cols(delta_recovery_noninvasive_normal, delta_recovery_invasive_normal)
```

```{r}
# Non-informative plot

# X axis
xlim_inf = -10
xlim_sup = 6
ticks_spacing = 2

# Assure subgroup order
# https://stackoverflow.com/questions/12774210/
# how-do-you-specifically-order-ggplot2-x-axis-instead-of-alphabetical-order

level_order = c("Invasive mechanical ventilation", "Non-invasive ventilation", "Simple oxygen only")

p1 = delta_noninformative %>%
  
  # make it tidy for ggplot
  pivot_longer(
    cols = c("Simple oxygen only":"Invasive mechanical ventilation"),
    names_to = "dist", values_to = "samples"
  ) %>%
  
  ggplot(aes(x = 100 * samples, y = factor(dist, level = level_order))) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(aes(fill = stat(x < 0)),
               .width = c(0.5, 0.95)
  ) +
  scale_fill_manual(values = c("gray80", "#7EBAC2")) +
  labs(
    x = "",
    y = "",
    title = "Non-informative priors\n"
  ) +
  scale_x_continuous(breaks = seq(from = xlim_inf, to = xlim_sup, ticks_spacing)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    plot.title.position = "plot",
    legend.position = "none",
    plot.margin = margin(20, 25, 0, 20)
  ) +
  coord_cartesian(xlim = c(xlim_inf, xlim_sup))
```

```{r}
# Evidence-based plot

p2 = delta_evidence %>%
  
  # make it tidy for ggplot
  pivot_longer(
    cols = c("Simple oxygen only":"Invasive mechanical ventilation"),
    names_to = "dist", values_to = "samples"
  ) %>%
  
  ggplot(aes(x = 100 * samples, y = factor(dist, level = level_order))) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(aes(fill = stat(x < 0)),
               .width = c(0.5, 0.95)
  ) +
  scale_fill_manual(values = c("gray80", "#A65041")) +
  labs(x = "\nRisk difference (%)",
       y = "",
       title = "Evidence-based priors\n"
  ) +
  scale_x_continuous(breaks = seq(from = xlim_inf, to = xlim_sup, ticks_spacing)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(0, 25, 10, 20)
  ) +
  coord_cartesian(xlim = c(xlim_inf, xlim_sup))
```

```{r, fig.align='center', fig.height=7, fig.width=9, fig.cap="Interval bars depict 50% and 95% credible intervals."}
p1 / p2 + plot_annotation(title = "Posterior distributions on mortality",
                          theme = theme(plot.title = element_text(size = 20)))
```


# Hospital discharge

**Regarding this outcome, negative risk differences mean benefit.**

<br>

## Using a non-informative prior
### Simple oxygen only

```{r, fig.align='center', fig.height=4, fig.width=7, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}

### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

n = 10e4 # To determine sampling size

# Here I use the uninformative_posterior_beta() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "beta_distributions.R")

beta_recovery_simple_oxygen = uniformative_posterior_beta( 
  recovery_simple_oxygen, # data
  "discharge" # outcome
) 

### Plot!

# I will use my own functions to standardize my plots

risk_comparison_plot(
  beta_recovery_simple_oxygen, # Data object

  ### start using quotes
  
  "gray50", # Color code for control group
  "#5C87C3", # Color code for other group
  "\nRisk (%)", # X axis label
  "RECOVERY trial", # Title
  "Simple oxygen only subgroup\n", # Subtitle
  
  ### stop using quotes

  58 , # X axis inferior limit
  76, # X axis superior limit
  2 # X axis spacing for ticks
)
```

```{r, fig.align='center', fig.height=4, fig.width=7}
xlabel = "\nRisk difference (%)"
xlim_inf = -2
xlim_sup = 14

p1 = risk_difference_plot(
  beta_recovery_simple_oxygen, # Data object

  ## start using quotes
  "#9D95C6", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # X axis label
) 

p2 = cumulative_risk_difference_plot(
  beta_recovery_simple_oxygen, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  1, # Spacing between ticks in X axis
  "discharge" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is greater than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "RECOVERY trial",
  subtitle = "Risk difference between groups on simple oxygen only"
)
```

### Non-invasive ventilation

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}

### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

n = 10e4 # To determine sampling size

# Here I use the uninformative_posterior_beta() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "beta_distributions.R")

beta_recovery_non_invasive = uniformative_posterior_beta( 
  recovery_non_invasive, # data
  "discharge" # outcome
) 

### Plot!

# I will be using my own functions to standardize my plots

risk_comparison_plot(
  beta_recovery_non_invasive, # Data object

  ### start using quotes
  
  "gray50", # Color code for control group
  "#5C87C3", # Color code for other group
  "\nRisk (%)", # X axis label
  "RECOVERY trial", # Title
  "Non-invasive ventilation subgroup\n", # Subtitle
  
  ### stop using quotes

  34, # X axis inferior limit
  52, # X axis superior limit
  2 # Spacing between ticks in X axis
)
```

```{r}
xlabel = "\nRisk difference (%)"
xlim_inf = -2
xlim_sup = 16

p1 = risk_difference_plot(
  beta_recovery_non_invasive, # Data object

  ## start using quotes
  "#9D95C6", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # Spacing between ticks in X axis
) 

p2 = cumulative_risk_difference_plot(
  beta_recovery_non_invasive, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  1, # Spacing between ticks in X axis
  "discharge" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is greater than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "RECOVERY trial",
  subtitle = "Risk difference between groups on non-invasive ventilation"
)
```

### Invasive mechanical ventilation

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}

### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

n = 10e4 # To determine sampling size

# Here I use the uninformative_posterior_beta() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "beta_distributions.R")

beta_recovery_invasive = uniformative_posterior_beta( 
  recovery_invasive, # data
  "discharge" # outcome
) 

### Plot!

# I will be using my own functions to standardize my plots

risk_comparison_plot(
  beta_recovery_invasive, # Data object

  ### start using quotes
  
  "gray50", # Color code for control group
  "#5C87C3", # Color code for other group
  "\nRisk (%)", # X axis label
  "RECOVERY trial", # Title
  "Invasive mechanical ventilation subgroup\n", # Subtitle
  
  ### stop using quotes

  10, # X axis inferior limit
  26, # X axis superior limit
  2 # Spacing between ticks in X axis
) + 
  
  # Extra function to better limits the axis in this case
  coord_cartesian(c(10, 26))
```

```{r}
xlabel = "\nRisk difference (%)"
xlim_inf = -8
xlim_sup = 12

p1 = risk_difference_plot(
  beta_recovery_invasive, # Data object

  ## start using quotes
  "#9D95C6", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  4 # Spacing between ticks in X axis
) 

p2 = cumulative_risk_difference_plot(
  beta_recovery_invasive, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2, # Spacing between ticks in X axis
  "discharge" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is greater than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "RECOVERY trial",
  subtitle = "Risk difference between groups on invasive mechanical ventilation"
)
```

## Using evidence-based priors

### Simple oxygen only

```{r, fig.align='center', fig.height=4, fig.width=5, warning=FALSE}

priors_simple_oxygen_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "simple oxygen"
  )

priors_simple_oxygen =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_simple_oxygen_raw %>% filter(outcome == "discharge"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_simple_oxygen)
```

```{r include=FALSE}
# Normal approximation function

recovery_simple_oxygen_normal = normal_approximation(
  recovery_simple_oxygen, # Data object with RECOVERY data
  "discharge", # Outcome (within quotes)
  priors_simple_oxygen, # Output from the rma() in the previous code chunk

  recovery_simple_oxygen_normal # Repeat the name of the object you are creating
)
  

```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}
set.seed = 123 # set seed for reproducibility (rnorm() function)
n = 10e4 # sampling size

xlabel = "\nRisk difference (%)"

data_prior_posterior_plot(
  recovery_simple_oxygen_normal, # Output from normal_approximation()
  
  # start using quotes
           "#364D55", # Color for the prior
           "#9D95C6", # Color for RECOVERY
           "#DBA237", # Color for the posterior
           xlabel, # X axis label
           "Posterior distribution: RECOVERY and previous evidence", # Title
           "Simple oxygen only subgroup", # Subtitle
           # stop using quotes
           -10, # X axis inferior limit
           20, # X axis superior limit
           5 # Spacing between ticks in X axis
  ) 

```

```{r}
xlim_inf = 0
xlim_sup = 14

p1 = posterior_difference_plot(
  recovery_simple_oxygen_normal, # Data object

  ## start using quotes
  "#DBA237", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # Spacing between ticks in X axis
) 

p2 = posterior_cumulative_plot(
  recovery_simple_oxygen_normal, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  1, # Spacing between ticks in X axis
  "discharge" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is greater than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "Posterior distribution: RECOVERY trial and previous evidence",
  subtitle = "Simple oxygen only subgroup"
)
```

### Non-invasive ventilation

```{r, fig.align='center', fig.height=4, fig.width=5}

priors_noninvasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "non-invasive ventilation"
  )

priors_noninvasive =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_noninvasive_raw %>% filter(outcome == "discharge"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_noninvasive)
```

```{r include=FALSE}
# Normal approximation function

recovery_noninvasive_normal = normal_approximation(
  recovery_non_invasive, # Data object with RECOVERY data
  "discharge", # Outcome (within quotes)
  priors_noninvasive, # Output from the rma() in the previous code chunk

  recovery_noninvasive_normal # Repeat the name of the object you are creating
)
  
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}
set.seed = 123 # set seed for reproducibility (rnorm() function)
n = 10e4 # sampling size

data_prior_posterior_plot(
  recovery_noninvasive_normal, # Output from normal_approximation()
  
  # start using quotes
           "#364D55", # Color for the prior
           "#9D95C6", # Color for RECOVERY
           "#DBA237", # Color for the posterior
           xlabel, # X axis label
           "Posterior distribution - RECOVERY and previous evidence", # Title
           "Non-invasive ventilation subgroup", # Subtitle
           # stop using quotes
           -10, # X axis inferior limit
           15, # X axis superior limit
           5 # Spacing between ticks in X axis
  ) 

```

```{r}
xlim_inf = -2
xlim_sup = 14

p1 = posterior_difference_plot(
  recovery_noninvasive_normal, # Data object

  ## start using quotes
  "#DBA237", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2 # Spacing between ticks in X axis
) 

p2 = posterior_cumulative_plot(
  recovery_noninvasive_normal, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  1, # Spacing between ticks in X axis
  "discharge" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is greater than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "Posterior distribution: RECOVERY trial and previous evidence",
  subtitle = "Non-invasive ventilation subgroup"
)
```

### Invasive mechanical ventilation
```{r, fig.align='center', fig.height=4, fig.width=5}

priors_invasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "invasive ventilation"
  )

priors_invasive =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_invasive_raw %>% filter(outcome == "discharge"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_invasive)
```

```{r include=FALSE}
# Normal approximation function

recovery_invasive_normal = normal_approximation(
  recovery_invasive, # Data object with RECOVERY data
  "discharge", # Outcome (within quotes)
  priors_invasive, # Object output from the rma() in the previous code chunk

  recovery_invasive_normal # Repeat the name of the object you are creating
)
  

```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="While the darker shaded area depicts the 50% credible interval (CI), the interval bar depicts the 95% CI."}
set.seed = 123 # set seed for reproducibility (rnorm() function)
n = 10e4 # sampling size

data_prior_posterior_plot(
  recovery_invasive_normal, # Output from normal_approximation()
  
  # start using quotes
           "#364D55", # Color for the prior
           "#9D95C6", # Color for RECOVERY
           "#DBA237", # Color for the posterior
           xlabel, # X axis label
           "Posterior distribution - RECOVERY and previous evidence", # Title
           "Invasive mechanical ventilation subgroup", # Subtitle
           # stop using quotes
           -10, # X axis inferior limit
           25, # X axis superior limit
           5 # Spacing between ticks in X axis
  ) 

```

```{r}
xlabel = "\nRisk difference (%)"
xlim_inf = -8
xlim_sup = 12

p1 = posterior_difference_plot(
  recovery_invasive_normal, # Data object

  ## start using quotes
  "#DBA237", # fill color code
  xlabel, # X axis label
  ### stop using quotes

  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  4 # Spacing between ticks in X axis
) 

p2 = posterior_cumulative_plot(
  recovery_invasive_normal, # Data object
  xlabel, # X axis label (in quotes)
  xlim_inf, # X axis inferior limit
  xlim_sup, # X axis superior limit
  2, # Spacing between ticks in X axis
  "discharge" # Outcome (within quotes)
  )
```

```{r, fig.align='center', fig.height=4, fig.width=7, warning=FALSE, fig.cap="The interval bar depicts the 95% credible interval. The cumulative posterior distribution corresponds to the probabilities that the risk difference (RD) is greater than or equal to the effect size on the X‐axis."}
p1 + p2 + plot_annotation(
  title = "Posterior distribution: RECOVERY trial and previous evidence",
  subtitle = "Invasive mechanical ventilation subgroup"
)
```

## Summary

```{r}
### Create variables for the summary plot

set.seed = 123 # set seed for reproducibility (rnorm())
n = 10e4 # sampling size


## Non-informative priors

delta_beta_recovery_simple_oxygen =
  beta_recovery_simple_oxygen %>%
  # Calculate difference between groups
  summarise("Simple oxygen only" = toci - control)

delta_beta_recovery_non_invasive =
  beta_recovery_non_invasive %>% 
  summarise("Non-invasive ventilation" = toci - control)

delta_beta_recovery_invasive =
  beta_recovery_invasive %>% 
  summarise("Invasive mechanical ventilation" = toci - control)

# Bind all 3 tibbles together
delta_noninformative = 
  delta_beta_recovery_simple_oxygen %>% 
  bind_cols(delta_beta_recovery_non_invasive, delta_beta_recovery_invasive)

## Evidence-based priors

delta_recovery_simple_oxygen_normal =
  recovery_simple_oxygen_normal %>%
  summarise("Simple oxygen only" = rnorm(n,
                                         mean = post.mean,
                                         sd = post.sd)
            )

delta_recovery_noninvasive_normal =
  recovery_noninvasive_normal %>%
  summarise("Non-invasive ventilation" = rnorm(n,
                                               mean = post.mean,
                                               sd = post.sd)
            )

delta_recovery_invasive_normal =
  recovery_invasive_normal %>%
  summarise("Invasive mechanical ventilation" = rnorm(n,
                                                      mean = post.mean,
                                                      sd = post.sd)
            )

# Bind all 3 tibbles together
delta_evidence = 
  delta_recovery_simple_oxygen_normal %>% 
  bind_cols(delta_recovery_noninvasive_normal, delta_recovery_invasive_normal)
```

```{r}
# Non-informative plot

# X axis
xlim_inf = -8
xlim_sup = 14
ticks_spacing = 2

# Assure subgroup order
# https://stackoverflow.com/questions/12774210/
# how-do-you-specifically-order-ggplot2-x-axis-instead-of-alphabetical-order

level_order = c("Invasive mechanical ventilation", "Non-invasive ventilation", "Simple oxygen only")

p1 = delta_noninformative %>%
  
  # make it tidy for ggplot
  pivot_longer(
    cols = c("Simple oxygen only":"Invasive mechanical ventilation"),
    names_to = "dist", values_to = "samples"
  ) %>%
  
  ggplot(aes(x = 100 * samples, y = factor(dist, level = level_order))) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(aes(fill = stat(x > 0)),
               .width = c(0.5, 0.95)
  ) +
  scale_fill_manual(values = c("gray80", "#9D95C6")) +
  labs(
    x = "",
    y = "",
    title = "Non-informative priors\n"
  ) +
  scale_x_continuous(breaks = seq(from = xlim_inf, to = xlim_sup, ticks_spacing)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    plot.title.position = "plot",
    legend.position = "none",
    plot.margin = margin(20, 25, 0, 20)
  ) +
  coord_cartesian(xlim = c(xlim_inf, xlim_sup))
```

```{r}
# Evidence-based plot

p2 = delta_evidence %>%
  
  # make it tidy for ggplot
  pivot_longer(
    cols = c("Simple oxygen only":"Invasive mechanical ventilation"),
    names_to = "dist", values_to = "samples"
  ) %>%
  
  ggplot(aes(x = 100 * samples, y = factor(dist, level = level_order))) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(aes(fill = stat(x > 0)),
               .width = c(0.5, 0.95)
  ) +
  scale_fill_manual(values = c("gray80", "#DBA237")) +
  labs(x = "\nRisk difference (%)",
       y = "",
       title = "Evidence-based priors\n"
  ) +
  scale_x_continuous(breaks = seq(from = xlim_inf, to = xlim_sup, ticks_spacing)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(0, 25, 10, 20)
  ) +
  coord_cartesian(xlim = c(xlim_inf, xlim_sup))
```

```{r, fig.height=7, fig.width=9, fig.align='center', fig.cap="Interval bars depict 50% and 95% credible intervals."}
p1 / p2 + plot_annotation(title = "Posterior distributions on hospital discharge",
                          theme = theme(plot.title = element_text(size = 20)))
```

<br><br>

```{r echo=TRUE}
sessionInfo()
```