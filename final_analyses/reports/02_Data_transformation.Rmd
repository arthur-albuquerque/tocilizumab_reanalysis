---
title: "02_Data_transformation"
author: "Arthur M. Albuquerque"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
          code_folding: show
          toc: yes
          toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
```

If you are not interested in the code, you can select the "Hide all code" option
on the upper-right corner.

```{r include=FALSE}
library(tidyverse) # Data wrangling and plotting
library(flextable) # To create tables
library(tidybayes) # To plot distributions
library(ggdist) # To plot distributions
library(patchwork) # To arrange multiple plots
library(here) # To find file paths within R project
library(metafor) # To create priors from meta-analysis
library(janitor) # To improve column's name
library(Hmisc) # To use %nin%

# to generate posteriors distributions from beta distributions using
# noninformative priors within tibbles

source(here("final_analyses", "script", "functions", # file path
            "noninformative_posterior.R"))           # file name

# To generate normal conjugate posterior probabilities

source(here("final_analyses", "script", "functions", # file path
            "conjugate_normal_posterior.R"))         # file name

# To generate posterior probabilities with an evidence-based prior
# (it requires "conjugate_normal_posterior.R" )

source(here("final_analyses", "script", "functions", # file path
            "normal_approximation.R"))               # file name

# To generate posterior probabilities with multiple priors
# (it requires "conjugate_normal_posterior.R" )

source(here("final_analyses", "script", "functions", # file path
            "normal_approximation_multiple_priors.R")) # file name

# To compile all posteriors into a tibble

source(here("final_analyses", "script", "functions", # file path
            "tibble_all_posteriors.R")) # file name


```

<br> 

Load data generated in the "01_Data_overview.Rmd" file.

```{r}

d = read.csv((here("final_analyses", "output", "data", # file path
                   "respiratory-data.csv")),           # file name
             header = T)
d = d %>% 
  as_tibble() %>% 
  select(!starts_with("X")) %>% 
  
  # To create columns with the difference between sample size and events per arm
  # This will be useful while using Beta distributions,
  # diff = the Beta (b) parameter in a Beta distribution (a,b)
  mutate(diff_toci = total_toci - events_toci,
         diff_control = total_control - events_control)
```

Filter data to create different objects.

```{r}
### To create separate objects per subgroup
# Here I rename columns so these variables are usable in my beta_fun()

# Isolating RECOVERY
recovery_simple_oxygen = 
  d %>% 
  filter(trial == "RECOVERY",
         oxygen == "simple oxygen") %>% 
  
  # Only RECOVERY, so there is no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control")

recovery_non_invasive = 
  d %>% 
  filter(trial == "RECOVERY",
         oxygen == "non-invasive ventilation") %>% 
  
  # Only RECOVERY, so there is no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control") 

recovery_invasive = 
  d %>% 
  filter(trial == "RECOVERY",
         oxygen == "invasive ventilation") %>% 
  
  # Only RECOVERY, so there is no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control")

## Group all other trials per outcome and sum the events/sample size

trials_simple_oxygen =
  d %>% 
  filter(trial != "RECOVERY",
         oxygen == "simple oxygen") %>% 
  
  # Only COVACTA, so no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control")

trials_non_invasive = 
  d %>% 
  filter(trial != "RECOVERY",
         oxygen == "non-invasive ventilation") %>%
  group_by(outcome) %>% 
  summarise(sum_events_toci = sum(events_toci),
            sum_total_toci = sum(total_toci),
            sum_diff_toci = sum(diff_toci),
            sum_events_control = sum(events_control),
            sum_total_control = sum(total_control),
            sum_diff_control = sum(diff_control))

trials_invasive = 
  d %>% 
  filter(trial != "RECOVERY",
         oxygen == "invasive ventilation") %>%
  group_by(outcome) %>% 
  summarise(sum_events_toci = sum(events_toci),
            sum_total_toci = sum(total_toci),
            sum_diff_toci = sum(diff_toci),
            sum_events_control = sum(events_control),
            sum_total_control = sum(total_control),
            sum_diff_control = sum(diff_control))
```

# Mortality outcome

## Non-informative priors

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() that you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_simple_oxygen_death = noninformative_posterior( 
  recovery_simple_oxygen, # data
  "mortality" # outcome
) 

noninformative_recovery_non_invasive_death = noninformative_posterior( 
  recovery_non_invasive, # data
  "mortality" # outcome
) 

noninformative_recovery_invasive_death = noninformative_posterior( 
  recovery_invasive, # data
  "mortality" # outcome
) 

```

### Simple oxygen only subgroup

```{r}

tibble(
  rows = dim(noninformative_recovery_simple_oxygen_death)[1],
  columns = dim(noninformative_recovery_simple_oxygen_death)[2]
  ) %>% 
  flextable()

head(noninformative_recovery_simple_oxygen_death) %>% flextable()
```

### Non-invasive ventilation subgroup

```{r}

tibble(
  rows = dim(noninformative_recovery_non_invasive_death)[1],
  columns = dim(noninformative_recovery_non_invasive_death)[2]
  ) %>% 
  flextable()

head(noninformative_recovery_non_invasive_death) %>% flextable()
```

### Invasive mechanical ventilation subgroup

```{r}

tibble(
  rows = dim(noninformative_recovery_invasive_death)[1],
  columns = dim(noninformative_recovery_invasive_death)[2]
  ) %>% 
  flextable()

head(noninformative_recovery_invasive_death) %>% flextable()
```

```{r}
# Save objects with posterior distributions using non-informative priors

# save(noninformative_recovery_simple_oxygen_death,
#      noninformative_recovery_non_invasive_death,
#      noninformative_recovery_invasive_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "noninformative_recovery_death.RData"))

```

## Evidence-based priors

### Simple oxygen only subgroup

```{r, fig.align='center', fig.height=4, fig.width=5}
priors_simple_oxygen_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "simple oxygen"
  )

priors_simple_oxygen_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_simple_oxygen_raw %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

# Visualize it
forest(priors_simple_oxygen_death)

```

```{r include=FALSE}
# Normal approximation function

recovery_simple_oxygen_normal_death = normal_approximation(
  recovery_simple_oxygen, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  priors_simple_oxygen_death, # Output from the rma() in the previous code chunk

  recovery_simple_oxygen_normal # Repeat the name of the object you are creating
)
```

```{r}
recovery_simple_oxygen_normal_death %>% flextable()
```

### Non-invasive ventilation subgroup

```{r, fig.align='center', fig.height=4, fig.width=5}
priors_noninvasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "non-invasive ventilation"
  )

priors_noninvasive_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_noninvasive_raw %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_noninvasive_death)
```

```{r include=FALSE}
# Normal approximation function

recovery_noninvasive_normal_death = normal_approximation(
  recovery_non_invasive, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  priors_noninvasive_death, # Output from the rma() in the previous code chunk

  recovery_noninvasive_normal # Repeat the name of the object you are creating
)
```

```{r}
recovery_noninvasive_normal_death %>% flextable()
```

### Invasive mechanical ventilation subgroup

```{r, fig.align='center', fig.height=4, fig.width=5}
priors_invasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "invasive ventilation"
  )

priors_invasive_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_invasive_raw %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_invasive_death)
```

```{r include=FALSE}
# Normal approximation function

recovery_invasive_normal_death = normal_approximation(
  recovery_invasive, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  priors_invasive_death, # Object output from the rma() in the previous code chunk

  recovery_invasive_normal # Repeat the name of the object you are creating
)

```

```{r}
recovery_invasive_normal_death %>% flextable()
```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_simple_oxygen_death,
#      priors_noninvasive_death,
#      priors_invasive_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_death.RData"))

```


## Alternative priors

### Simple oxygen subgroup

```{r include=FALSE}
multiple_priors_simple_oxygen_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_simple_oxygen_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_simple_oxygen_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_simple_oxygen_death %>% flextable() %>% autofit()
```


### Non-invasive ventilation subgroup

```{r include=FALSE}
multiple_priors_noninvasive_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_noninvasive_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_noninvasive_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_noninvasive_death %>% flextable() %>% autofit()
```

### Invasive mechanical ventilation subgroup

```{r include=FALSE}
multiple_priors_invasive_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_invasive_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_invasive_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_invasive_death %>% flextable() %>% autofit()
```
## Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

## Simple oxygen
all_posteriors_simple_oxygen_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_simple_oxygen_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_simple_oxygen_death 
)

## Non-invasive ventilation
all_posteriors_noninvasive_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_non_invasive_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_noninvasive_death 
)

## Invasive mechanical ventilation
all_posteriors_invasive_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_invasive_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_invasive_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_simple_oxygen_death)%>% flextable() %>% autofit()
```


```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_simple_oxygen_death,
#      multiple_priors_noninvasive_death,
#      multiple_priors_invasive_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "multiple_priors_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_simple_oxygen_death,
#      all_posteriors_noninvasive_death,
#      all_posteriors_invasive_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_death.RData"))

```

# Hospital discharge outome

## Non-informative priors

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() that you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_simple_oxygen_discharge = noninformative_posterior( 
  recovery_simple_oxygen, # data
  "discharge" # outcome
) 

noninformative_recovery_non_invasive_discharge = noninformative_posterior( 
  recovery_non_invasive, # data
  "discharge" # outcome
) 

noninformative_recovery_invasive_discharge = noninformative_posterior( 
  recovery_invasive, # data
  "discharge" # outcome
) 
```

### Simple oxygen only subgroup

```{r}
tibble(
  rows = dim(noninformative_recovery_simple_oxygen_discharge)[1],
  columns = dim(noninformative_recovery_simple_oxygen_discharge)[2]
  ) %>% 
  flextable()

head(noninformative_recovery_simple_oxygen_discharge) %>% flextable()
```

### Non-invasive ventilation subgroup

```{r}
tibble(
  rows = dim(noninformative_recovery_non_invasive_discharge)[1],
  columns = dim(noninformative_recovery_non_invasive_discharge)[2]
  ) %>% 
  flextable()

head(noninformative_recovery_non_invasive_discharge) %>% flextable()
```

### Invasive mechanical ventilation subgroup

```{r}
tibble(
  rows = dim(noninformative_recovery_invasive_discharge)[1],
  columns = dim(noninformative_recovery_invasive_discharge)[2]
  ) %>% 
  flextable()

head(noninformative_recovery_invasive_discharge) %>% flextable()
```

```{r}
# Save objects for the posterior using non-informative priors

# save(noninformative_recovery_simple_oxygen_discharge,
#      noninformative_recovery_non_invasive_discharge,
#      noninformative_recovery_invasive_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                  "noninformative_recovery_discharge.RData"))

```

## Evidence-based priors

### Simple oxygen only subgroup

```{r}
priors_simple_oxygen_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "simple oxygen"
  )

priors_simple_oxygen_discharge =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_simple_oxygen_raw %>% filter(outcome == "discharge"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_simple_oxygen_discharge)
```

```{r include=FALSE}
# Normal approximation function

recovery_simple_oxygen_normal_discharge = normal_approximation(
  recovery_simple_oxygen, # Data object with RECOVERY data
  "discharge", # Outcome (within quotes)
  priors_simple_oxygen_discharge, # Output from the rma() in the previous code chunk

  recovery_simple_oxygen_normal_discharge # Repeat the name of the object you are creating
)

```

```{r}
recovery_simple_oxygen_normal_discharge %>% flextable()
```

### Non-invasive ventilation subgroup

```{r, fig.align='center', fig.height=4, fig.width=5}

priors_noninvasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "non-invasive ventilation"
  )

priors_noninvasive_discharge =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_noninvasive_raw %>% filter(outcome == "discharge"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_noninvasive_discharge)
```

```{r include=FALSE}
# Normal approximation function

recovery_noninvasive_normal_discharge = normal_approximation(
  recovery_non_invasive, # Data object with RECOVERY data
  "discharge", # Outcome (within quotes)
  priors_noninvasive_discharge, # Output from the rma() in the previous code chunk

  recovery_noninvasive_normal_discharge # Repeat the name of the object you are creating
)
  
```

```{r}
recovery_noninvasive_normal_discharge %>% flextable()
```

### Invasive mechanical ventilation subgroup

```{r, fig.align='center', fig.height=4, fig.width=5}

priors_invasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "invasive ventilation"
  )

priors_invasive_discharge =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_invasive_raw %>% filter(outcome == "discharge"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_invasive_discharge)
```

```{r include=FALSE}
# Normal approximation function

recovery_invasive_normal_discharge = normal_approximation(
  recovery_invasive, # Data object with RECOVERY data
  "discharge", # Outcome (within quotes)
  priors_invasive_discharge, # Object output from the rma() in the previous code chunk

  recovery_invasive_normal # Repeat the name of the object you are creating
)
  

```

```{r}
recovery_invasive_normal_discharge %>% flextable()
```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_simple_oxygen_discharge,
#      priors_noninvasive_discharge,
#      priors_invasive_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_discharge.RData"))

```

## Alternative priors

### Simple oxygen subgroup

```{r include=FALSE}
multiple_priors_simple_oxygen_discharge =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_simple_oxygen_normal_discharge, 
  "discharge", # Outcome (within quotes)
  multiple_priors_simple_oxygen_discharge # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_simple_oxygen_discharge %>% flextable() %>% autofit()
```


### Non-invasive ventilation subgroup

```{r include=FALSE}
multiple_priors_noninvasive_discharge =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_noninvasive_normal_discharge, 
  "discharge", # Outcome (within quotes)
  multiple_priors_noninvasive_discharge # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_noninvasive_discharge %>% flextable() %>% autofit()
```

### Invasive mechanical ventilation subgroup

```{r include=FALSE}
multiple_priors_invasive_discharge =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_invasive_normal_discharge, 
  "discharge", # Outcome (within quotes)
  multiple_priors_invasive_discharge # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_invasive_discharge %>% flextable() %>% autofit()
```

## Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

## Simple oxygen
all_posteriors_simple_oxygen_discharge = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_simple_oxygen_discharge, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_simple_oxygen_discharge 
)

## Non-invasive ventilation
all_posteriors_noninvasive_discharge = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_non_invasive_discharge, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_noninvasive_discharge 
)

## Invasive mechanical ventilation
all_posteriors_invasive_discharge = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_invasive_discharge, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_invasive_discharge 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_simple_oxygen_discharge) %>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_simple_oxygen_discharge,
#      multiple_priors_noninvasive_discharge,
#      multiple_priors_invasive_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                  "multiple_priors_discharge.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_simple_oxygen_discharge,
#      all_posteriors_noninvasive_discharge,
#      all_posteriors_invasive_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_discharge.RData"))

```

# Corticosteroid subgroups

```{r include=FALSE}

d = readxl::read_excel(here("final_analyses", "data", # file path
                            "corticosteroids_subgroup_extracted-data.xlsx")) 

d = clean_names(d) %>% 
   # To create columns with the difference between sample size and events per arm
  # This will be useful while using Beta distributions,
  # diff = the Beta (b) parameter in a Beta distribution (a,b)
  mutate(diff_toci = total_toci - events_toci,
         diff_control = total_control - events_control)

recovery_using_cortico_data =
  d %>%
  filter(trial == "RECOVERY",
    corticosteroids == 1
  ) %>%
  # Only RECOVERY, so there is no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control")

recovery_not_cortico_data =
  d %>%
  filter(trial == "RECOVERY",
    corticosteroids == 0
  ) %>%
  # Only RECOVERY, so there is no need to sum, just to rename the columns
  rename(sum_events_toci = "events_toci",
         sum_total_toci = "total_toci",
         sum_diff_toci = "diff_toci",
         sum_events_control = "events_control",
         sum_total_control = "total_control",
         sum_diff_control = "diff_control")

```

Let's check how much data we have

```{r}
d %>% 
  filter(corticosteroids == 1) %>% 
  group_by(trial, outcome) %>%
  count() %>% 
  select(-n) %>% 
  flextable() %>% 
  autofit()
``` 

```{r}
d %>% 
  group_by(trial, outcome) %>% 
  summarise("total number of patients" = sum(total_control + total_toci)) %>% 
  flextable() %>% 
  autofit()
```

## REMAP-CAP

Regarding this trial, we extracted data on corticosteroid subgroups from
Figure 9 in their appendix. Unfortunately, the authors don't provide raw number
of events in each subgroup. Thus, I used the [{juicr}
package](https://cran.r-project.org/web/packages/juicr/index.html) to extract
data directly from Figure 9. The raw data and extraction report generated by
{juicr} can be found in the "final\_analyses/data" folder in my
[GitHub](https://github.com/arthur-albuquerque/tocilizumab_reanalysis).

<br>

Of note, REMAP-CAP is a three-arm randomized controlled trial that tested
tocilizumab and sarilumab (both are IL-6 antagonist) vs. usual care. The authors
only provided pooled data from these IL-6 antagonists vs. usual care in
Figure 9. Thus, we decided to analyze data on corticosteroid subgroups from
REMAP-CAP with different weights: 100%, 75%, 50%, and 0%. In this way, the
numbers of events and sample sizes are multiplied by 1, 0.75, 0.5, or 0,
respectively. These different weights will directly reflect on the variance of
the prior distribution, increasing its uncertainty.

Here are the original (100% weight) number of events and sample sizes from the
REMAP-CAP trial:

```{r}
d %>% 
  filter(trial == "REMAP-CAP") %>% 
  select(trial:total_control) %>% 
  flextable() %>% 
  autofit()
```
Now with 75% weight:

```{r}
# Create custom function
multiply75 = function(x){x*0.75}

remap75 = d %>% 
  filter(trial == "REMAP-CAP") %>% 
  # Multiply columns regarding events and sample size using custom function
  mutate(across(events_toci:total_control, ~ multiply75(.))) %>% 
  # Re-calculate "diff" columns with 75% weight data
  mutate(diff_toci = total_toci - events_toci,
         diff_control = total_control - events_control) %>% 
  # Change name of the trial
  mutate(trial = "75% REMAP-CAP")

remap75 %>% 
  flextable() %>%
  autofit()
```

Now with 50% weight:

```{r}
# Create custom function
multiply50 = function(x){x*0.50}

remap50 = d %>% 
  filter(trial == "REMAP-CAP") %>% 
  # Multiply columns regarding events and sample size using custom function
  mutate(across(events_toci:total_control, ~ multiply50(.))) %>% 
  # Re-calculate "diff" columns with 50% weight data
  mutate(diff_toci = total_toci - events_toci,
         diff_control = total_control - events_control) %>% 
  # Change name of the trial
  mutate(trial = "50% REMAP-CAP")
  
remap50 %>%   
  flextable() %>%
  autofit()
```
0% weight means that data from the REMAP-CAP trial wouldn't be used in the analysis:

```{r}
# Create custom function
multiply0 = function(x){x*0}

remap0 = d %>% 
  filter(trial == "REMAP-CAP") %>% 
  # Multiply columns regarding events and sample size using custom function
  mutate(across(events_toci:total_control, ~ multiply0(.))) %>% 
  # Re-calculate "diff" columns with 0% weight data
  mutate(diff_toci = total_toci - events_toci,
         diff_control = total_control - events_control) %>% 
  # Change name of the trial
  mutate(trial = "0% REMAP-CAP")
  
remap0 %>%   
  flextable() %>%
  autofit()
```
Now let's add this data as new rows in our data frame:

```{r}
d = d %>% 
  bind_rows(remap75, remap50)

d %>%
  distinct(trial) %>% 
  flextable() %>% 
  autofit()
```


## Mortality outcome

### Using REMAP-CAP with 100% weight

#### Using corticosteroids

Let's start the data wrangling

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_100_using_cortico_data_death =
  d %>%
  # Remove rows using different weights on REMAP-CAP
  filter(str_detect(trial, "%", negate = TRUE)) %>% 
  filter(
    trial != "RECOVERY", # Not RECOVERY
    corticosteroids == 1 # Using corticosteroids
  )

priors_100_using_cortico_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_100_using_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_100_using_cortico_death,
       showweights = T,
       refline     = 0)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_100_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_100_using_cortico_death.RData"))

```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the uninformative_posterior_beta() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_using_cortico_death = noninformative_posterior( 
  recovery_using_cortico_data, # data
  "mortality" # outcome
) 

```

```{r}
# Save objects with posterior distributions using non-informative priors

# save(noninformative_recovery_using_cortico_death,
#    
#    file = here("final_analyses", "output", "data",
#                "noninformative_recovery_using_cortico_death.RData"))

```

```{r include=FALSE}
# Normal approximation function

recovery_100_using_cortico_normal_death = normal_approximation(
  
  recovery_using_cortico_data, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_100_using_cortico_death, 

  recovery_100_using_cortico_normal_death # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_100_using_cortico_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_100_using_cortico_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_100_using_cortico_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_100_using_cortico_death %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_100_using_cortico_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_using_cortico_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_100_using_cortico_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_100_using_cortico_death)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_100_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_100_using_cortico_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_100_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_100_using_cortico_death.RData"))

```

#### Not using corticosteroids

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_100_not_cortico_data_death =
  d %>%
  # Remove rows using different weights on REMAP-CAP
  filter(str_detect(trial, "%", negate = TRUE)) %>% 
  filter(
    trial != "RECOVERY", # Not RECOVERY
    corticosteroids == 0 # Not using corticosteroids
  )

priors_100_not_cortico_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_100_not_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_100_not_cortico_death,
       showweights = T,
       refline     = 0)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

save(priors_100_not_cortico_death,
     
     file = here("final_analyses", "output", "data",
                 "priors_100_not_cortico_death.RData"))

```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_not_cortico_death = noninformative_posterior( 
  recovery_not_cortico_data, # data
  "mortality" # outcome
) 

```

```{r}
# Save objects with posterior distributions using non-informative priors

# save(noninformative_recovery_not_cortico_death,
#    
#    file = here("final_analyses", "output", "data",
#                "noninformative_recovery_not_cortico_death.RData"))

```

```{r include=FALSE}
# Normal approximation function

recovery_100_not_cortico_normal_death = normal_approximation(
  
  recovery_not_cortico_data, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_100_not_cortico_death, 

  recovery_100_not_cortico_normal_death # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_100_not_cortico_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_100_not_cortico_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_100_priors_not_cortico_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_100_not_cortico_death %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_100_not_cortico_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_not_cortico_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_100_not_cortico_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_100_not_cortico_death)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_100_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_100_not_cortico_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_100_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_100_not_cortico_death.RData"))

```

### Using REMAP-CAP with 75% weight

#### Using corticosteroids

Let's start the data wrangling

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_75_using_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "50% REMAP-CAP"), # Not 50%
    corticosteroids == 1 # Using corticosteroids
  )

priors_75_using_cortico_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_75_using_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_75_using_cortico_death,
       showweights = T,
       refline     = 0)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_75_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_75_using_cortico_death.RData"))

```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_using_cortico_death = noninformative_posterior( 
  recovery_using_cortico_data, # data
  "mortality" # outcome
) 

```

```{r include=FALSE}
# Normal approximation function

recovery_75_using_cortico_normal_death = normal_approximation(
  
  recovery_using_cortico_data, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_75_using_cortico_death, 

  recovery_75_using_cortico_normal_death # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_75_using_cortico_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_75_using_cortico_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_75_using_cortico_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_75_using_cortico_death %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_75_using_cortico_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_using_cortico_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_75_using_cortico_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_75_using_cortico_death)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_75_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_75_using_cortico_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_75_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_75_using_cortico_death.RData"))

```

#### Not using corticosteroids

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_75_not_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "50% REMAP-CAP"), # Not 50%
    corticosteroids == 0 # Not using corticosteroids
  )

priors_75_not_cortico_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_75_not_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_75_not_cortico_death,
       showweights = T,
       refline     = 0)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_75_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_75_not_cortico_death.RData"))
# 
```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_not_cortico_death = noninformative_posterior( 
  recovery_not_cortico_data, # data
  "mortality" # outcome
) 

```

```{r include=FALSE}
# Normal approximation function

recovery_75_not_cortico_normal_death = normal_approximation(
  
  recovery_not_cortico_data, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_75_not_cortico_death, 

  recovery_75_not_cortico_normal_death # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_75_not_cortico_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_75_not_cortico_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_75_not_cortico_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_75_not_cortico_death %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_75_not_cortico_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_not_cortico_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_75_not_cortico_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_75_not_cortico_death)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_75_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_75_not_cortico_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_75_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_75_not_cortico_death.RData"))

```

### Using REMAP-CAP with 50% weight

#### Using corticosteroids

Let's start the data wrangling

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_50_using_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "75% REMAP-CAP"), # Not 75%
    corticosteroids == 1 # Using corticosteroids
  )

priors_50_using_cortico_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_50_using_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_50_using_cortico_death,
       showweights = T,
       refline     = 0)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_50_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_50_using_cortico_death.RData"))

```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_using_cortico_death = noninformative_posterior( 
  recovery_using_cortico_data, # data
  "mortality" # outcome
) 

```

```{r include=FALSE}
# Normal approximation function

recovery_50_using_cortico_normal_death = normal_approximation(
  
  recovery_using_cortico_data, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_50_using_cortico_death, 

  recovery_50_using_cortico_normal_death # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_50_using_cortico_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_50_using_cortico_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_50_using_cortico_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_50_using_cortico_death %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_50_using_cortico_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_using_cortico_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_50_using_cortico_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_50_using_cortico_death)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_50_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_50_using_cortico_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_50_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_50_using_cortico_death.RData"))

```

#### Not using corticosteroids

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_50_not_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "75% REMAP-CAP"), # Not 75%
    corticosteroids == 0 # Not using corticosteroids
  )

priors_50_not_cortico_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_50_not_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_50_not_cortico_death,
       showweights = T,
       refline     = 0)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_50_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_50_not_cortico_death.RData"))
# 
```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_not_cortico_death = noninformative_posterior( 
  recovery_not_cortico_data, # data
  "mortality" # outcome
) 

```

```{r include=FALSE}
# Normal approximation function

recovery_50_not_cortico_normal_death = normal_approximation(
  
  recovery_not_cortico_data, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_50_not_cortico_death, 

  recovery_50_not_cortico_normal_death # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_50_not_cortico_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_50_not_cortico_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_50_not_cortico_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_50_not_cortico_death %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_50_not_cortico_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_not_cortico_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_50_not_cortico_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_50_not_cortico_death)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_50_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_50_not_cortico_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_50_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_50_not_cortico_death.RData"))

```

### Using REMAP-CAP with 0% weight

#### Using corticosteroids

Let's start the data wrangling

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_0_using_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "75% REMAP-CAP", # Not 75%
    "50% REMAP-CAP"), # Not 75%
    corticosteroids == 1 # Using corticosteroids
  )

priors_0_using_cortico_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_0_using_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_0_using_cortico_death,
       showweights = T,
       refline     = 0)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_0_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_0_using_cortico_death.RData"))

```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_using_cortico_death = noninformative_posterior( 
  recovery_using_cortico_data, # data
  "mortality" # outcome
) 

```

```{r include=FALSE}
# Normal approximation function

recovery_0_using_cortico_normal_death = normal_approximation(
  
  recovery_using_cortico_data, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_0_using_cortico_death, 

  recovery_0_using_cortico_normal_death # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_0_using_cortico_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_0_using_cortico_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_0_using_cortico_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_0_using_cortico_death %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_0_using_cortico_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_using_cortico_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_0_using_cortico_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_0_using_cortico_death)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_0_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_0_using_cortico_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_0_using_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_0_using_cortico_death.RData"))

```

#### Not using corticosteroids

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_0_not_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "75% REMAP-CAP",
    "50% REMAP-CAP"), # Not 75%
    corticosteroids == 0 # Not using corticosteroids
  )

priors_0_not_cortico_death =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_0_not_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_0_not_cortico_death,
       showweights = T,
       refline     = 0)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_0_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_0_not_cortico_death.RData"))
# 
```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_not_cortico_death = noninformative_posterior( 
  recovery_not_cortico_data, # data
  "mortality" # outcome
) 

```

```{r include=FALSE}
# Normal approximation function

recovery_0_not_cortico_normal_death = normal_approximation(
  
  recovery_not_cortico_data, # Data object with RECOVERY data
  "mortality", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_0_not_cortico_death, 

  recovery_0_not_cortico_normal_death # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_0_not_cortico_death =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_0_not_cortico_normal_death, 
  "mortality", # Outcome (within quotes)
  multiple_priors_0_not_cortico_death # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_0_not_cortico_death %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_0_not_cortico_death = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_not_cortico_death, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_0_not_cortico_death 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_0_not_cortico_death)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_0_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_0_not_cortico_death.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_0_not_cortico_death,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_0_not_cortico_death.RData"))

```

### Summary

#### Using corticosteroids

```{r}
pal = c("100%" = "#D49352", 
        "75%" = "#479ED0",
        "50%" = "#A64E49",
        "0%" = "#85AD99") 

plot_prior = ggplot(data = data.frame(x = c(-0.3, 0.3)), aes(x)) +
  
  stat_function(fun = dnorm, n = 1000,
                args = list(mean = priors_100_using_cortico_death$beta,
                            sd = priors_100_using_cortico_death$se),
                aes(colour = "100%"),
                linetype = 1, size = 1) + 
  
  stat_function(fun = dnorm, n = 1000,
                args = list(mean = priors_75_using_cortico_death$beta,
                            sd = priors_75_using_cortico_death$se),
                aes(colour = "75%"),
                linetype = 1, size = 1) +
  
  stat_function(fun = dnorm, n = 1000,
                args = list(mean = priors_50_using_cortico_death$beta,
                            sd = priors_50_using_cortico_death$se),
                aes(colour = "50%"),
                linetype = 1, size = 1) +
  
  stat_function(fun = dnorm, n = 1000,
                args = list(mean = priors_0_using_cortico_death$beta,
                            sd = priors_0_using_cortico_death$se),
                aes(colour = "0%"),
                linetype = 1, size = 1) + 
  
  geom_vline(xintercept = 0, color="grey70", linetype = 2) +
  
  scale_colour_manual("Weight on\nREMAP-CAP",values = pal) +   # legend
  
  # to split legend in two rows https://ggplot2.tidyverse.org/reference/guide_legend.html
  guides(col = guide_legend(nrow = 2)) +  
  
  labs(title = "Priors", x="Risk difference (%)", y = "Density") +
  
  scale_x_continuous(breaks=seq(from = -0.2, to = 0.2, 0.1)) +
  scale_y_continuous(limits=c(0, 7)) +
  
  theme_classic() +
  theme(axis.line.y=element_blank(),
        axis.title = element_text(size = 13),
        axis.text.y=element_blank(),
        axis.text.x = element_text(size = 11),
        axis.ticks.y=element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.position = "top",
        plot.margin = margin(25,25,10,25)) +
  
  coord_cartesian(expand = T, clip = 'off')

plot_prior
```


## Hospital discharge outcome

**There is no data available from the RECAP-CAP trial.**

### Using corticosteroids

Let's start the data wrangling

```{r, fig.align='center', fig.height=4, fig.width=5}

priors_using_cortico_data_discharge =
  d %>%
  filter(
    trial != "RECOVERY", # Not RECOVERY
    corticosteroids == 1 # Using corticosteroids
  )

priors_using_cortico_discharge =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_using_cortico_data_discharge %>% filter(outcome == "discharge"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_using_cortico_discharge)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_using_cortico_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_using_cortico_discharge.RData"))

```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_using_cortico_discharge = noninformative_posterior( 
  recovery_using_cortico_data, # data
  "discharge" # outcome
) 

```

```{r}
# Save objects with posterior distributions using non-informative priors

# save(noninformative_recovery_using_cortico_discharge,
#    
#    file = here("final_analyses", "output", "data",
#                "noninformative_recovery_using_cortico_discharge.RData"))

```

```{r include=FALSE}
# Normal approximation function

recovery_using_cortico_normal_discharge = normal_approximation(
  
  recovery_using_cortico_data, # Data object with RECOVERY data
  "discharge", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_using_cortico_discharge, 

  recovery_using_cortico_normal_discharge # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_using_cortico_discharge =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_using_cortico_normal_discharge, 
  "discharge", # Outcome (within quotes)
  multiple_priors_using_cortico_discharge # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_using_cortico_discharge %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_using_cortico_discharge = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_using_cortico_discharge, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_using_cortico_discharge 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_using_cortico_discharge)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_using_cortico_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_using_cortico_discharge.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_using_cortico_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_using_cortico_discharge.RData"))

```

### Not using corticosteroids

```{r, fig.align='center', fig.height=4, fig.width=5}

priors_not_cortico_data_discharge =
  d %>%
  filter(
    trial != "RECOVERY",
    corticosteroids == 0 # Not using corticosteroids
  )

priors_not_cortico_discharge =
  rma(
    # Outcome
    measure = "RD", # risk difference
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_not_cortico_data_discharge %>% filter(outcome == "discharge"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_not_cortico_discharge)

```

```{r}
## Save objects with rma() outputs to show forest plot in other files

# save(priors_not_cortico_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                  "priors_not_cortico_discharge.RData"))

```

```{r}
### Generate posterior beta distributions using a noninformative beta(1,1) prior

set.seed = 123 # set seed for reproducibility (rbeta() function)

# Here I use the noninformative_posterior() in which you can find in the
# following path: 
# here("final_analyses", "script", "functions", "noninformative_posterior.R")

noninformative_recovery_not_cortico_discharge = noninformative_posterior( 
  recovery_not_cortico_data, # data
  "discharge" # outcome
) 

```

```{r}
# Save objects with posterior distributions using non-informative priors

# save(noninformative_recovery_not_cortico_discharge,
#    
#    file = here("final_analyses", "output", "data",
#                "noninformative_recovery_not_cortico_discharge.RData"))

```

```{r include=FALSE}
# Normal approximation function

recovery_not_cortico_normal_discharge = normal_approximation(
  
  recovery_not_cortico_data, # Data object with RECOVERY data
  "discharge", # Outcome (within quotes)
  
  # Output from the rma() in the previous code chunk
  priors_not_cortico_discharge, 

  recovery_not_cortico_normal_discharge # Repeat the name of the object you are creating
)
```

```{r include=FALSE}
multiple_priors_not_cortico_discharge =
  normal_approximation_multiple_priors(
  # Data object with evidence-based posterior from normal_approximation()
  recovery_not_cortico_normal_discharge, 
  "discharge", # Outcome (within quotes)
  multiple_priors_not_cortico_discharge # Name for the final output with data+prior+posterior
  )
```

```{r}
multiple_priors_not_cortico_discharge %>% flextable() %>% autofit()
```

Compiling all posteriors

```{r}
### Compile noninformative prior + other priors into a tibble for summary plot

all_posteriors_not_cortico_discharge = tibble_all_posteriors(
  
  # Output from noninformative_posterior()
  noninformative_recovery_not_cortico_discharge, 
  
  # Output from normal_approximation_multiple_priors()
  multiple_priors_not_cortico_discharge 
)
```

Example of one output with all the posteriors

```{r}
head(all_posteriors_not_cortico_discharge)%>% flextable() %>% autofit()
```

```{r}
## Save objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

# save(multiple_priors_not_cortico_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                   "multiple_priors_not_cortico_discharge.RData"))

```

```{r}
## Save objects with all posteriors

# save(all_posteriors_not_cortico_discharge,
#      
#      file = here("final_analyses", "output", "data",
#                  "all_posteriors_not_cortico_discharge.RData"))

```

<br><br>

```{r echo=TRUE}
sessionInfo()
```