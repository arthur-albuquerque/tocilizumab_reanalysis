---
title: "03_Figures_Draft"
author: "Arthur M. Albuquerque"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
          toc: yes
          toc_float: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # no code
```

```{r include=FALSE}
# Ensures the package "pacman" is installed
if (!require("pacman")) install.packages("pacman")

# p_load() installs (if necessary) and loads the following packages

pacman::p_load(rio, # To import data
               here, # To find file paths within R project
               janitor, # To change column names
               tidyverse, # Data wrangling and plotting
               ggdist, # To plot distributions
               patchwork, # To arrange plots
               gt, # To create nice tables
               kableExtra, # To create nice tables
               Cairo # To export PDF files
               )
```


```{r}
## Load objects with mean + SD of multiple priors along with
## RECOVERY data and posterior distributions

load(file = here("final_analyses", "output", "data", "analyses", # file path
                 "data_prior_posteriors_mean_sd_death.RData"))   # file name

## Load posterior distributions' samples with logOR, OR and RD

# I uploaded these data objects to OSF since the .RData file is 54MB.
# Here I load all data files directly from OSF without having to download it
# to my/your PC

samples = url("https://osf.io/3qexw/download?version=1")
load(gzcon(samples))

# Load original data extraction table

d = import((here("final_analyses", "output", "data", # file path
                   "respiratory-data.csv")),           # file name
             header = T)
d = d %>% 
  as_tibble() %>% 
  select(!starts_with("X")) 

# Create different variables per subgroup

priors_simple_oxygen_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "simple oxygen",
    outcome == "mortality"
  )

priors_noninvasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "non-invasive ventilation",
    outcome == "mortality"
  )

priors_invasive_raw =
  d %>%
  filter(
    trial != "RECOVERY",
    oxygen == "invasive ventilation",
    outcome == "mortality"
  )

recovery_simple_oxygen = d %>%
  filter(trial == "RECOVERY",
         outcome == "mortality",
         oxygen == "simple oxygen")

recovery_noninvasive = d %>%
  filter(trial == "RECOVERY",
         outcome == "mortality",
         oxygen == "non-invasive ventilation")

recovery_invasive = d %>%
  filter(trial == "RECOVERY",
         outcome == "mortality",
         oxygen == "invasive ventilation")
  

# Load corticosteroids raw data

d_cortico = import(here("final_analyses", "data", # file path
                            "corticosteroids_subgroup_extracted-data.xlsx"))

d_cortico = clean_names(d_cortico)

priors_not_using =
  d_cortico %>%
  filter(
    trial != "RECOVERY",
    corticosteroids == 0,
    outcome == "mortality"
  )

priors_using =
  d_cortico %>%
  filter(
    trial != "RECOVERY",
    corticosteroids == 1,
    outcome == "mortality"
  )

recovery_not_using = d_cortico %>%
  filter(trial == "RECOVERY",
         outcome == "mortality",
         corticosteroids == 0)

recovery_using = d_cortico %>%
  filter(trial == "RECOVERY",
         outcome == "mortality",
         corticosteroids == 1)

```

```{r}
# Set seed for reproducibility

set.seed = 123 
```

<br>

**In this document, I will only present data regarding the mortality outcome. Thus, positive risk differences mean benefit.**

## Table 1: Overall view of the data

Here, the primary aim is to give an overall view of how many patients are
involved in each subgroup and study.

```{r}

respiratory_table = 
  d %>% 
  # only mortality
  filter(outcome == "mortality") %>% 
  # change names to display them in the table
  mutate(oxygen = case_when(
    oxygen == "simple oxygen" ~ "Simple oxygen only",
    oxygen == "non-invasive ventilation" ~ "Non-invasive ventilation",
    oxygen == "invasive ventilation" ~ "Invasive mechanical ventilation",
  )) %>% 
  # Remove any row with NA, eg, the ones with "Pooled" in oxygen
  drop_na() %>%
  # Create columns with Risk (%) for both control and tocilizumab
  mutate(risk_control = 100*round(events_control/total_control, 2),
         risk_toci = 100*round(events_toci/total_toci,2)) %>% 
  # Order columns
  select(oxygen,
         trial,
         events_control, total_control, risk_control,
         events_toci, total_toci, risk_toci) %>% 
  # Rename to match the next table
  rename("Subgroup" = oxygen)

cortico_table = 
  d_cortico %>% 
  filter(outcome == "mortality") %>% 
  mutate(corticosteroids = case_when(
    corticosteroids == 0 ~ "Not using corticosteroids",
    corticosteroids == 1 ~ "Using corticosteroids"
  )) %>%
  mutate(risk_control = 100*round(events_control/total_control, 2),
         risk_toci = 100*round(events_toci/total_toci,2)) %>% 
  select(corticosteroids,
         trial,
         events_control, total_control, risk_control,
         events_toci, total_toci, risk_toci) %>% 
  rename("Subgroup" = corticosteroids)

# Put both tables togehter
both_tables = bind_rows(respiratory_table, cortico_table)

table1 = both_tables %>% 
  # Rename for final table
  rename("Study" = trial,
         "Events" = events_control,
         "Total" = total_control,
         "Risk (%)" = risk_control,
         "Events " = events_toci,
         "Total " = total_toci,
         "Risk (%) " = risk_toci) %>% 
  # Define order for final table
  mutate(Subgroup = factor(Subgroup,
                        levels = c("Not using corticosteroids",
                                   "Using corticosteroids",
                                   "Simple oxygen only",
                                   "Non-invasive ventilation",
                                   "Invasive mechanical ventilation")),
         Study = factor(Study,
                        levels = c("RECOVERY",
                                   "COVACTA",
                                   "REMAP-CAP",
                                   "CORIMUNO-19",
                                   "Salvarini"))) %>%
  # Re-arrange based on Study name
  arrange(Study) %>% 
  # Gropup to create row tabs with gt()
  group_by(Subgroup) %>% 
  # https://stackoverflow.com/questions/43832434/arrange-within-a-group-with-dplyr
  arrange(Subgroup, .by_group = TRUE) %>% 
  
  ### Transform into HTML table with gt()
  gt() %>% 
  # Centralize columns
  cols_align(
    align = "center",
    columns = everything()
  ) %>% 
  # Expand the size of first column
  cols_width(
    Study ~ px(250)
  ) %>% 
  # Add column tabs based on the column names defined above
  tab_spanner(label = "Control",
              columns = c("Events", "Total", "Risk (%)")) %>% 
  tab_spanner(label = "Tocilizumab",
              columns = c("Events ", "Total ", "Risk (%) "))

table1 

# table1 %>% 
#   gtsave(here("final_analyses", "output", "plots", "manuscript", # File path
#                    "table1.png"))
  
```


```{r}
## Same table as above, but in this case I made it "manually" lol

t = tibble(
  "Subgroup" = c("Not using corticosteroids",
                 " ", # RECOVERY
                 " ", # gap
                 " ", # COVACTA
                 " ", # REMAP-CAP
                 "Using corticosteroids",
                 " ", # RECOVERY
                 " ", # gap
                 " ", # COVACTA
                 " ", # REMAP-CAP
                 "Simple oxygen only",
                 " ", # RECOVERY
                 " ", # gap
                 " ", # COVACTA
                 " ",  # CORIMUNO-19
                 "Non-invasive ventilation",
                 " ", # RECOVERY
                 " ", # gap
                 " ", # COVACTA
                 " ", # REMAP-CAP
                 " ", # Salvarini et al.
                 "Invasive mechanical ventilation",
                 " ", # RECOVERY
                 " ", # gap
                 " ", # COVACTA
                 " "  # REMAP-CAP
                 
  ),
  
  
  "Study" = c(
    ### Use of corticosteroids
    ## Not using
    " ",
    "RECOVERY",
    # Prior
    " ",
    "COVACTA",
    "REMAP-CAP",
    
    ## Using
    " ",
    "RECOVERY",
    # Prior
    " ",
    "COVACTA",
    "REMAP-CAP",
    
    ### Respiratory support
    ## Simple oxygen only
    " ",
    "RECOVERY",
    # Prior
    " ",
    "COVACTA",
    "CORIMUNO-19",
    
    
    ## Non-invasive ventilation
    " ",
    "RECOVERY",
    # Prior
    " ",
    "COVACTA",
    "REMAP-CAP",
    "Salvarini et al.",
    
    ## Invasive mechanical ventilation
    " ",
    "RECOVERY",
    # Prior
    " ",
    "COVACTA",
    "REMAP-CAP"
    
    ),
  
  # Control
  
  "Events" = c(
    ### Use of corticosteroids
    ## Not using
    " ",
    # RECOVERY
    recovery_not_using %>% 
      select(events_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_not_using %>% 
      filter(trial == "COVACTA") %>% 
      select(events_control) %>% pull(),
    # REMAP-CAP
    priors_not_using %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(events_control) %>% pull(),
    
    ## Using
    " ",
    # RECOVERY
    recovery_using %>% 
      select(events_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_using %>% 
      filter(trial == "COVACTA") %>% 
      select(events_control) %>% pull(),
    # REMAP-CAP
    priors_using %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(events_control) %>% pull(),
    
    ### Respiratory support
    ## Simple oxygen only
    " ",
    # RECOVERY
    recovery_simple_oxygen %>% 
      select(events_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_simple_oxygen_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(events_control) %>% pull(),
    # CORIMUNO-19
    priors_simple_oxygen_raw %>% 
      filter(trial == "CORIMUNO-19") %>% 
      select(events_control) %>% pull(),
    
    ## Non-invasive ventilation
    " ",
    # RECOVERY
    recovery_noninvasive %>% 
      select(events_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_noninvasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(events_control) %>% pull(),
    # REMAP-CAP
    priors_noninvasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(events_control) %>% pull(),
    # Salvarini
    priors_noninvasive_raw %>% 
      filter(trial == "Salvarini") %>% 
      select(events_control) %>% pull(),
    
    ## Invasive mechanical ventilation
    " ",
    # RECOVERY
    recovery_invasive %>% 
      select(events_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_invasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(events_control) %>% pull(),
    # REMAP-CAP
    priors_invasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(events_control) %>% pull()
    
  ),
  
  "Total" = c(
  ### Use of corticosteroids
  ## Not using
    " ",
    # RECOVERY
    recovery_not_using %>% 
      select(total_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_not_using %>% 
      filter(trial == "COVACTA") %>% 
      select(total_control) %>% pull(),
    # REMAP-CAP
    priors_not_using %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(total_control) %>% pull(),
    
    ## Using
    " ",
    # RECOVERY
    recovery_using %>% 
      select(total_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_using %>% 
      filter(trial == "COVACTA") %>% 
      select(total_control) %>% pull(),
    # REMAP-CAP
    priors_using %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(total_control) %>% pull(),
    
    ### Respiratory support
    ## Simple oxygen only
    " ",
    # RECOVERY
    recovery_simple_oxygen %>% 
      select(total_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_simple_oxygen_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(total_control) %>% pull(),
    # CORIMUNO-19
    priors_simple_oxygen_raw %>% 
      filter(trial == "CORIMUNO-19") %>% 
      select(total_control) %>% pull(),
    
    ## Non-invasive ventilation
    " ",
    # RECOVERY
    recovery_noninvasive %>% 
      select(total_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_noninvasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(total_control) %>% pull(),
    # REMAP-CAP
    priors_noninvasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(total_control) %>% pull(),
    # Salvarini
    priors_noninvasive_raw %>% 
      filter(trial == "Salvarini") %>% 
      select(total_control) %>% pull(),
    
    ## Invasive mechanical ventilation
    " ",
    # RECOVERY
    recovery_invasive %>% 
      select(total_control) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_invasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(total_control) %>% pull(),
    # REMAP-CAP
    priors_invasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(total_control) %>% pull()
  ),
  
  "Risk (%)" = c(
  ### Use of corticosteroids
  ## Not using
    " ",
    # RECOVERY
    recovery_not_using %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_not_using %>% 
      filter(trial == "COVACTA") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # REMAP-CAP
    priors_not_using %>% 
      filter(trial == "REMAP-CAP") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    
    ## Using
    " ",
    # RECOVERY
    recovery_using %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_using %>% 
      filter(trial == "COVACTA") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # REMAP-CAP
    priors_using %>% 
      filter(trial == "REMAP-CAP") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    
    ### Respiratory support
    ## Simple oxygen only
    " ",
    # RECOVERY
    recovery_simple_oxygen %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_simple_oxygen_raw %>% 
      filter(trial == "COVACTA") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # CORIMUNO-19
    priors_simple_oxygen_raw %>% 
      filter(trial == "CORIMUNO-19") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    
    ## Non-invasive ventilation
    " ",
    # RECOVERY
    recovery_noninvasive %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_noninvasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # REMAP-CAP
    priors_noninvasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # Salvarini
    priors_noninvasive_raw %>% 
      filter(trial == "Salvarini") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    
    ## Invasive mechanical ventilation
    " ",
    # RECOVERY
    recovery_invasive %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_invasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    # REMAP-CAP
    priors_invasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull()
  ),

  
  # Tocilizumab
  
  "Events " = c(
  ### Use of corticosteroids
  ## Not using
    " ",
    # RECOVERY
    recovery_not_using %>% 
      select(events_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_not_using %>% 
      filter(trial == "COVACTA") %>%
      select(events_toci) %>% pull(),
    # REMAP-CAP
    priors_not_using %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(events_toci) %>% pull(),
    
    ## Using
    " ",
    # RECOVERY
    recovery_using %>% 
      select(events_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_using %>% 
      filter(trial == "COVACTA") %>%
      select(events_toci) %>% pull(),
    # REMAP-CAP
    priors_using %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(events_toci) %>% pull(),
    
    ### Respiratory support
    ## Simple oxygen only
    " ",
    # RECOVERY
    recovery_simple_oxygen %>% 
      select(events_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_simple_oxygen_raw %>% 
      filter(trial == "COVACTA") %>%
      select(events_toci) %>% pull(),
    # CORIMUNO-19
    priors_simple_oxygen_raw %>% 
      filter(trial == "CORIMUNO-19") %>% 
      select(events_toci) %>% pull(),
    
    ## Non-invasive ventilation
    " ",
    # RECOVERY
    recovery_noninvasive %>% 
      select(events_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_noninvasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(events_toci) %>% pull(),
    # REMAP-CAP
    priors_noninvasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(events_toci) %>% pull(),
    # Salvarini
    priors_noninvasive_raw %>% 
      filter(trial == "Salvarini") %>% 
      select(events_toci) %>% pull(),
    
    ## Invasive mechanical ventilation
    " ",
    # RECOVERY
    recovery_invasive %>% 
      select(events_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_invasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(events_toci) %>% pull(),
    # REMAP-CAP
    priors_invasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(events_toci) %>% pull()
  ),
  
  "Total " = c(
  ### Use of corticosteroids
  ## Not using
    " ",
    # RECOVERY
    recovery_not_using %>% 
      select(total_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_not_using %>% 
      filter(trial == "COVACTA") %>%
      select(total_toci) %>% pull(),
    # REMAP-CAP
    priors_not_using %>% 
      filter(trial == "REMAP-CAP") %>%
      select(total_toci) %>% pull(),
    
    ## Using
    " ",
    # RECOVERY
    recovery_using %>% 
      select(total_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_using %>% 
      filter(trial == "COVACTA") %>%
      select(total_toci) %>% pull(),
    # REMAP-CAP
    priors_using %>% 
      filter(trial == "REMAP-CAP") %>%
      select(total_toci) %>% pull(),
    
    ### Respiratory support
    ## Simple oxygen only
    " ",
    # RECOVERY
    recovery_simple_oxygen %>% 
      select(total_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_simple_oxygen_raw %>% 
      filter(trial == "COVACTA") %>%
      select(total_toci) %>% pull(),
    # CORIMUNO-19
    priors_simple_oxygen_raw %>% 
      filter(trial == "CORIMUNO-19") %>%
      select(total_toci) %>% pull(),
    
    ## Non-invasive ventilation
    " ",
    # RECOVERY
    recovery_noninvasive %>% 
      select(total_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_noninvasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(total_toci) %>% pull(),
    # REMAP-CAP
    priors_noninvasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(total_toci) %>% pull(),
    # Salvarini
    priors_noninvasive_raw %>% 
      filter(trial == "Salvarini") %>% 
      select(total_toci) %>% pull(),
    
    ## Invasive mechanical ventilation
    " ",
    # RECOVERY
    recovery_invasive %>% 
      select(total_toci) %>% pull(),
    # Prior
    " ",
    # COVACTA
    priors_invasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      select(total_toci) %>% pull(),
    # REMAP-CAP
    priors_invasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      select(total_toci) %>% pull()
    
  ),
  
  "Risk (%) " = c(
  ### Use of corticosteroids
  ## Not using
    " ",
    # RECOVERY 
    recovery_not_using %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_not_using %>% 
      filter(trial == "COVACTA") %>%
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # REMAP-CAP
    priors_not_using %>% 
      filter(trial == "REMAP-CAP") %>%
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    
    ## Using
    " ",
    # RECOVERY 
    recovery_using %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_using %>% 
      filter(trial == "COVACTA") %>%
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # REMAP-CAP
    priors_using %>% 
      filter(trial == "REMAP-CAP") %>%
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    
    ### Respiratory support
    ## Simple oxygen only
    " ",
    # RECOVERY
    recovery_simple_oxygen %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_simple_oxygen_raw %>% 
      filter(trial == "COVACTA") %>%
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # CORIMUNO-19
    priors_simple_oxygen_raw %>% 
      filter(trial == "CORIMUNO-19") %>%
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    
    ## Non-invasive ventilation
    " ",
    # RECOVERY
    recovery_noninvasive %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_noninvasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # REMAP-CAP
    priors_noninvasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # Salvarini
    priors_noninvasive_raw %>% 
      filter(trial == "Salvarini") %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    
    ## Invasive mechanical ventilation
    " ",
    # RECOVERY
    recovery_invasive %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # Prior
    " ",
    # COVACTA
    priors_invasive_raw %>% 
      filter(trial == "COVACTA") %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull(),
    # REMAP-CAP
    priors_invasive_raw %>% 
      filter(trial == "REMAP-CAP") %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
      pull()
    
  )
  
  
) 

# t %>%
#   gt() %>% 
#   tab_spanner(label = "Control",
#               columns = c("Events", "Total", "Risk (%)")) %>% 
#   tab_spanner(label = "Tocilizumab",
#               columns = c("Events ", "Total ", "Risk (%) ")) %>% 
#   cols_align(
#     align = "center",
#     columns = everything()
#   ) 

# t %>% 
#   gtsave(here("final_analyses", "output", "plots", "manuscript", # File path
#                   "table1.png"))
```


```{r}
## DEPRECATED

t = tibble(
  
  "Subgroup" = c(
    "Not using",
    "Using",
    
    "Simple oxygen only",
    "Non-invasive ventilation",
    "Invasive mechanical ventilation"
    
  ),
  
  ## Priors
  
  "Number of studies" = c(
    
    priors_not_using %>%
      count() %>% pull(),
    priors_using %>%
      count() %>% pull(),
    
    priors_simple_oxygen_raw %>%
      count() %>% pull(),
    priors_noninvasive_raw %>%
      count() %>% pull(),
    priors_invasive_raw %>%
      count() %>% pull()
    
  ),
  
  # Control arm
  
  "Events  " = c(
    
    priors_not_using %>%
    summarise(n = sum(events_control)) %>% pull(),
    priors_using %>%
      summarise(n = sum(events_control)) %>% pull(),
    
    priors_simple_oxygen_raw %>%
      summarise(n = sum(events_control)) %>% pull(),
    priors_noninvasive_raw %>%
      summarise(n = sum(events_control)) %>% pull(),
    priors_invasive_raw %>%
      summarise(n = sum(events_control)) %>% pull()

  ),
  
  "Total  " = c(
    
    priors_not_using %>%
      summarise(n = sum(total_control)) %>% pull(),
    priors_using %>%
      summarise(n = sum(total_control)) %>% pull(),
    
    priors_simple_oxygen_raw %>%
      summarise(n = sum(total_control)) %>% pull(),
    priors_noninvasive_raw %>%
      summarise(n = sum(total_control)) %>% pull(),
    priors_invasive_raw %>%
      summarise(n = sum(total_control)) %>% pull()

  ),
  
   "Risk (%)" = c(
    
    priors_not_using %>%
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    priors_using %>%
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    
    priors_simple_oxygen_raw %>%
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    priors_noninvasive_raw %>%
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    priors_invasive_raw %>%
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull()

  ),
  
  # Tocilizumab arm
  
  "Events   " = c(
    priors_not_using %>%
      summarise(n = sum(events_toci)) %>% pull(),
    priors_using %>%
      summarise(n = sum(events_toci)) %>% pull(),
    
    priors_simple_oxygen_raw %>%
      summarise(n = sum(events_toci)) %>% pull(),
    priors_noninvasive_raw %>%
      summarise(n = sum(events_toci)) %>% pull(),
    priors_invasive_raw %>%
      summarise(n = sum(events_toci)) %>% pull()
    
  ),
  
  "Total   " = c(
    priors_not_using %>%
      summarise(n = sum(total_toci)) %>% pull(),
    priors_using %>%
      summarise(n = sum(total_toci)) %>% pull(),
    
    priors_simple_oxygen_raw %>%
      summarise(n = sum(total_toci)) %>% pull(),
    priors_noninvasive_raw %>%
      summarise(n = sum(total_toci)) %>% pull(),
    priors_invasive_raw %>%
      summarise(n = sum(total_toci)) %>% pull()

  ),
  
  "Risk (%) " = c(
  
  priors_not_using %>%
    summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull(),
  priors_using %>%
    summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull(),
  
  priors_simple_oxygen_raw %>%
    summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull(),
  priors_noninvasive_raw %>%
    summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull(),
  priors_invasive_raw %>%
    summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull()
  
),
  
  ## RECOVERY
  
  # Control arm
  
  "Events" = c(
    recovery_not_using %>% 
      select(events_control) %>% pull(),
    recovery_using %>% 
      select(events_control) %>% pull(),
    
    recovery_simple_oxygen %>% 
      select(events_control) %>% pull(),
    recovery_noninvasive %>% 
      select(events_control) %>% pull(),
    recovery_invasive %>% 
      select(events_control) %>% pull()

  ),
  
  "Total" = c(
    
    recovery_not_using %>% 
      select(total_control) %>% pull(),
    recovery_using %>% 
      select(total_control) %>% pull(),
    
    recovery_simple_oxygen %>% 
      select(total_control) %>% pull(),
    recovery_noninvasive %>% 
      select(total_control) %>% pull(),
    recovery_invasive %>% 
      select(total_control) %>% pull()

  ),

  "Risk (%)  " = c(
    
    recovery_not_using %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    recovery_using %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    
    recovery_simple_oxygen %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    recovery_noninvasive %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull(),
    recovery_invasive %>% 
      summarise(n = round(100*sum(events_control)/sum(total_control),1)) %>%
      pull()

  ),
  
  # Tocilizumab arm
  
  "Events " = c(
    recovery_not_using %>% 
      select(events_toci) %>% pull(),
    recovery_using %>% 
      select(events_toci) %>% pull(),
    
   recovery_simple_oxygen %>% 
      select(events_toci) %>% pull(),
    recovery_noninvasive %>% 
      select(events_toci) %>% pull(),
   recovery_invasive %>% 
      select(events_toci) %>% pull()

  ),
  
  "Total " = c(
    
    recovery_not_using %>% 
      select(total_toci) %>% pull(),
    recovery_using %>% 
      select(total_toci) %>% pull(),
    
    recovery_simple_oxygen %>% 
      select(total_toci) %>% pull(),
    recovery_noninvasive %>% 
      select(total_toci) %>% pull(),
    recovery_invasive %>% 
      select(total_toci) %>% pull()

  ),

  "Risk (%)   " = c(
    
    recovery_not_using %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull(),
    recovery_using %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull(),
    
    recovery_simple_oxygen %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull(),
    recovery_noninvasive %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull(),
    recovery_invasive %>% 
      summarise(n = round(100*sum(events_toci)/sum(total_toci),1)) %>%
    pull()

  )
  
)

# Use kableExtra to have a nice table

# t1 = t %>% 
#   kbl(booktabs = T, align = 'c') %>% 
#   kable_styling(bootstrap_options = "striped", full_width = T) %>%
#   column_spec(c(5,8,11,14), bold = T) %>% 
#   add_header_above(c(" " = 2,
#                      "Control" = 3,
#                      "Tocilizumab" = 3,
#                      "Control" = 3,
#                      "Tocilizumab" = 3)) %>% 
#   add_header_above(c(" " = 1,
#                      "Priors" = 7,
#                      "RECOVERY" = 6)) %>% 
#   pack_rows("Use of corticosteroids", 1, 2) %>% 
#   pack_rows("Respiratory support", 3, 5)

# t1

#t1 %>% 
#  save_kable(here("final_analyses", "output", "plots", "manuscript", # File path
#                  "table1.pdf")) # File name
```

<br><br>

## Figure 1: Overall view of the data

Here, the primary aim is to visually present our priors and the RECOVERY.
I believe it is extremely important to present this data in a figure since
they are the foundation underlying the posterior distributions in the next
figures. I note that the x axis in Panel B is still "under construction". I want
to maintain the scale on Odds Ratio, but the prior for simple oxygen only is
very uncertain, ranging from ~0.49 to ~3.8. So I am trying to simulate an axis
break.

```{r}
# Corticosteroids subgroups

# Create data frame

# Not using corticosteroids subgroup

distributions_not =
  posteriors_not_using_death %>%
  filter(type == "evidence-based") %>%
  summarise(
    RECOVERY_not = list(rnorm(10e4,
      mean = data.mean,
      sd = data.sd
    )),
    Prior_not = list(rnorm(10e4,
      mean = prior.mean,
      sd = prior.sd
    ))
  ) %>%
  unnest(RECOVERY_not:Prior_not)

distributions_not = bind_cols(
  distributions_not,
# Bind corresponding posterior distribution data
samples_posteriors_not_using_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`log(OR)`) %>% 
  rename("Posterior_not" = `log(OR)`)
)

# Using corticosteroids subgroup

distributions_u =
  posteriors_using_death %>%
  filter(type == "evidence-based") %>%
  summarise(
    RECOVERY_u = list(rnorm(10e4,
      mean = data.mean,
      sd = data.sd
    )),
    Prior_u = list(rnorm(10e4,
      mean = prior.mean,
      sd = prior.sd
    ))
  ) %>%
  unnest(RECOVERY_u:Prior_u)

distributions_u = bind_cols(
  distributions_u,
# Bind corresponding posterior distribution data
samples_posteriors_using_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`log(OR)`) %>% 
  rename("Posterior_u" = `log(OR)`)
)

# Bind altogether

distributions_cortico = bind_cols(
  distributions_not,
  distributions_u
  
)
    
```


```{r}

# Prepare arrows under axis
# Adapted from https://github.com/rdboyes/forester/blob/master/R/forester.R


arrow_labels = c("Tocilizumab Benefit", "Tocilizumab Harm")

xlim = c(0, 20)

xlab_df = data.frame(text = arrow_labels,
                          x = c(2,18),
                          y = c(0, 0),
                          hjust = c(0, 1))

a_small_amount = abs(xlim[1] - xlim[2])/35

null_line_at = 10

arrow_df = data.frame(id = c(1,2),
                      xstart = c(null_line_at - a_small_amount,
                                      null_line_at + a_small_amount),
                      xend = c(xlim[1] + a_small_amount, xlim[2] - a_small_amount),
                      y = c(1, 1))

arrows_plot = ggplot() +
      geom_segment(data = arrow_df,
                   aes(x = .data$xstart,
                       xend = .data$xend,
                       y = .data$y,
                       yend = .data$y),
                   arrow = arrow(angle = 15, type = "closed", length = grid::unit(0.1, "in"))) +
  geom_text(data = xlab_df,
            aes(x = .data$x,
                y = .data$y,
                label = .data$text,
                hjust = .data$hjust), size = 3.5) +
  scale_y_continuous(expand = c(0,0), limits = c(-0.5, 1.75)) +
  scale_x_continuous(expand = c(0,0), limits = xlim) +
  theme(panel.background = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.box.background = element_rect(fill = "transparent"),
        panel.border = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank())



# Plot!

p1 =  
  distributions_cortico %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(RECOVERY_not:Posterior_u),
    names_to = "dist", values_to = "samples"
  ) %>%
  mutate(
    # Create new column to be able to use facet at the end
    subgroup = case_when(
      str_detect(dist, "_u") ~ "Using corticosteroids",
      str_detect(dist, "_not") ~ "Not using corticosteroids"
    ),

    # Set order of subgroups
    subgroup = factor(subgroup,
      levels = c(
        "Not using corticosteroids",
        "Using corticosteroids"
      )
    ),

    # Remove "_u" and "_not"
    dist = case_when(
      str_detect(dist, "RECOVERY") ~ "RECOVERY",
      str_detect(dist, "Prior") ~ "Prior",
      str_detect(dist, "Posterior") ~ "Posterior"
    ),
    # Set order of distributions
    dist = factor(dist,
      levels = c(
        "Posterior",
        "RECOVERY",
        "Prior"
      )
    )
  ) %>% 
  # exp() to convert log-odds ratio into odds ratio
  ggplot(aes(
    x = exp(samples), y = dist,
    fill = dist
  )) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(position = "dodge",
               point_interval = median_hdi, # Highest density interval
               .width = c(0.95)) +
  geom_vline(xintercept = 1, linetype = 2, size = 0.6) +
  scale_fill_manual(' ',
                    breaks=c("Prior","RECOVERY", "Posterior"),
                    values = c(
    "gray70", # Prior
    "#67B8D5", # RECOVERY
    "#F8D08D" # Posterior
  )) +
  labs(
    x = "\nOdds Ratio",
    y = " "
  ) +
  scale_x_continuous(breaks = seq(from = 0.25, to = 1.75, 0.25)) +
  coord_cartesian(xlim = c(0.25, 1.75),
                  clip = 'off') +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'right',
    #legend.text.align = 0.5,
    legend.margin = margin(0, 0, 0, 10),
    legend.text = element_text(size=12),
    legend.key= element_blank(),
    plot.margin = margin(20, 0, 60, 25)
  ) +
  facet_wrap(~subgroup, ncol = 1)
  
```

```{r}
## Respiratory support

# Create data frame

# Simple oxygen subgroup

distributions_s =
  posteriors_simple_death %>%
  filter(type == "evidence-based") %>%
  summarise(
    RECOVERY_s = list(rnorm(10e4,
      mean = data.mean,
      sd = data.sd
    )),
    Prior_s = list(rnorm(10e4,
      mean = prior.mean,
      sd = prior.sd
    ))
  ) %>%
  unnest(RECOVERY_s:Prior_s)

distributions_s = bind_cols(
  distributions_s,
# Bind corresponding posterior distribution data
samples_posteriors_simple_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`log(OR)`) %>% 
  rename("Posterior_s" = `log(OR)`)
)

# Non-invasive ventilation

distributions_n =
  posteriors_noninvasive_death %>%
  filter(type == "evidence-based") %>%
  summarise(
    RECOVERY_n = list(rnorm(10e4,
      mean = data.mean,
      sd = data.sd
    )),
    Prior_n = list(rnorm(10e4,
      mean = prior.mean,
      sd = prior.sd
    ))
  ) %>%
  unnest(RECOVERY_n:Prior_n)

distributions_n = bind_cols(
  distributions_n,
# Bind corresponding posterior distribution data
samples_posteriors_noninvasive_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`log(OR)`) %>% 
  rename("Posterior_n" = `log(OR)`)
)

# Invasive mechanical ventilation subgroup

distributions_i =
  posteriors_invasive_death %>%
  filter(type == "evidence-based") %>%
  summarise(
    RECOVERY_i = list(rnorm(10e4,
      mean = data.mean,
      sd = data.sd
    )),
    Prior_i = list(rnorm(10e4,
      mean = prior.mean,
      sd = prior.sd
    ))
  ) %>%
  unnest(RECOVERY_i:Prior_i)

distributions_i = bind_cols(
  distributions_i,
# Bind corresponding posterior distribution data
samples_posteriors_invasive_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`log(OR)`) %>% 
  rename("Posterior_i" = `log(OR)`)
)

# Bind altogether

distributions_respiratory = bind_cols(
  distributions_i,
  distributions_n,
  distributions_s
)
```

```{r}

# Create blank plot to simulate break in axis

text = data.frame(text = " ",
                          x = c(0,1),
                          y = c(0, 0),
                          hjust = c(0, 1))

blank_plot = ggplot() +
  geom_text(data = text,
            aes(x = .data$x,
                y = .data$y,
                label = .data$text,
                hjust = .data$hjust), size = 3.5) +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "white"),
        legend.box.background = element_rect(fill = "white"),
        panel.border = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank())

# Plot!

p2 = distributions_respiratory %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(RECOVERY_i:Posterior_s),
    names_to = "dist", values_to = "samples"
  ) %>%
  mutate(
    # Create new column to be able to use facet at the end
    subgroup = case_when(
      str_detect(dist, "_s") ~ "Simple oxygen only",
      str_detect(dist, "_n") ~ "Non-invasive ventilation",
      str_detect(dist, "_i") ~ "Invasive mechanical ventilation"
    ),

    # Set order of subgroups
    subgroup = factor(subgroup,
      levels = c(
        "Simple oxygen only",
        "Non-invasive ventilation",
        "Invasive mechanical ventilation"
      )
    ),

    # Remove "_i", "_n" and "_s"
    dist = case_when(
      str_detect(dist, "RECOVERY") ~ "RECOVERY",
      str_detect(dist, "Prior") ~ "Prior",
      str_detect(dist, "Posterior") ~ "Posterior"
    ),
    # Set order of distributions
    dist = factor(dist,
      levels = c(
        "Posterior",
        "RECOVERY",
        "Prior"
      )
    )
  ) %>%
  # exp() to convert log-odds ratio into odds ratio
  ggplot(aes(
    x = exp(samples), y = dist,
    fill = dist
  )) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(position = "dodge",
               point_interval = median_hdi, # HDI
               .width = c(0.95)) +
  scale_fill_manual(values = c(
    "#F8D08D", # Posterior
    "#67B8D5", # RECOVERY
    "gray70" # Priors
    
  )) +
  geom_vline(xintercept = 1, linetype = 2, size = 0.6) +
  labs(
    x = "\nOdds Ratio",
    y = " "
  ) +
  scale_x_continuous(breaks = c(0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75),
                     labels = c("0.25","0.50", "0.75", "1.00",
                                "1.25",
                                "   1.50   / /",
                                "  3.60")) +
  geom_vline(xintercept = 1.6, linetype = 2, size = 0.4, color = "gray80") +
  geom_vline(xintercept = 1.66, linetype = 2, size = 0.4, color = "gray80") +
  coord_cartesian(xlim = c(0.25, 1.75)) +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'none',
    plot.margin = margin(20, 15, 60, 0)
  ) +
  facet_wrap(~subgroup, ncol = 1)
```

```{r, fig.align='center', fig.width=10, fig.height = 6, fig.cap="Point estimates depict the median and interval bars depict 95% highest density intervals"}

p1_overlay = p1 + inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(1.5, 'cm'),
                                bottom = unit(0.4, 'cm'),
                                right = unit(11.03, 'cm'),
                                top = unit(2.3, 'cm'))
# Plot everything

p1_overlay +
  p2 +
  inset_element(arrows_plot,
                ignore_tag = TRUE,
                align_to = "full",
                left = unit(0.5, 'cm'),
                bottom = unit(0.4, 'cm'),
                right = unit(10.3, 'cm'),
                top = unit(2.3, 'cm')) +
  inset_element(blank_plot,
                ignore_tag = TRUE,
                align_to = "full",
                left = unit(8.77, 'cm'),
                right = unit(8.85, 'cm'),
                bottom = unit(12, 'cm'),
                top = unit(12.6, 'cm'))+
  plot_annotation(tag_levels = 'A')

# ggsave(width = 10,
#        height = 6,
#        here("final_analyses", "output", "plots", "manuscript", # File path
#                   "figure1.pdf")) # File name
```

<br><br>

Here are the 95% HDIs in *odds ratio* for each distribution from
the figure above.

```{r}
t = distributions_cortico %>% 
  # make it tidy to be able to use group_by()
  pivot_longer(
    cols = c(RECOVERY_not:Posterior_u),
    names_to = "Subgroup", values_to = "samples"
  ) %>% 
  # Group by distribution so we can apply median_hdi
  group_by(Subgroup) %>% 
  # Calculate the median and 95% HDI in log-odds ratio
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  select(Subgroup:.upper) %>% 
  # Exponentiate to transform log-odds ratio into odds ratio
  mutate(across(samples:.upper, ~exp(.))) %>%
  mutate(across(samples:.upper, ~round(., 2))) %>%
  # Set order
  mutate(Subgroup = factor(Subgroup,
                           levels = c(
                             "Prior_not", "RECOVERY_not", "Posterior_not",
                             "Prior_u", "RECOVERY_u", "Posterior_u"
                           ))) %>% 
  arrange(Subgroup) %>%
  rename("Median" = samples,
         "Upper limit" = .upper,
         "Lower limit" = .lower)
```


<br>

```{r}
# https://stackoverflow.com/questions/26548495/reorder-rows-using-custom-order
# create a vector with letters in the desired order
x = c("Prior_s", "RECOVERY_s", "Posterior_s",
      "Prior_n", "RECOVERY_n", "Posterior_n",
      "Prior_i", "RECOVERY_i", "Posterior_i")

t1 = distributions_respiratory %>% 
  # make it tidy to be able to use group_by()
  pivot_longer(
    cols = c(RECOVERY_i:Posterior_s),
    names_to = "Subgroup", values_to = "samples"
  ) %>% 
  # Group by distribution so we can apply median_hdi
  group_by(Subgroup) %>% 
  # Calculate the median and 95% HDI in log-odds ratio
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  select(Subgroup:.upper) %>% 
  # Exponentiate to transform log-odds ratio into odds ratio
  mutate(across(samples:.upper, ~exp(.))) %>% 
  mutate(across(samples:.upper, ~round(., 2))) %>%
  # Define order
  mutate(Subgroup = factor(Subgroup, levels = x)) %>% 
  arrange(Subgroup) %>%
  rename("Median" = samples,
         "Upper limit" = .upper,
         "Lower limit" = .lower)

```

```{r}

tfinal = bind_rows(t, t1) %>% 
  mutate(
    Subgroup = case_when(
      str_detect(Subgroup, "Prior") ~ "Prior",
      str_detect(Subgroup, "RECOVERY") ~ "RECOVERY",
      str_detect(Subgroup, "Posterior") ~ "Posterior"
    )) %>% 
  rename("Distribution" = Subgroup) %>% 
  gt() %>%
  cols_width(
    Distribution ~ px(230)
  ) %>% 
  tab_row_group(
    label = "Invasive mechanical ventilation",
    rows = 13:15
  ) %>% 
  tab_row_group(
    label = "Non-invasive ventilation",
    rows = 10:12
  ) %>% 
  tab_row_group(
    label = "Simple oxygen only",
    rows = 7:9
  ) %>%
  tab_row_group(
    label = "Using corticosteroids",
    rows = 4:6
  ) %>% 
  tab_row_group(
    label = "Not using corticosteroids",
    rows = 1:3
  ) %>% 
  cols_align(
    align = "center",
    columns = everything()
  ) 

tfinal

# tfinal %>% 
#   gtsave(here("final_analyses", "output", "plots", "appendix", # File path
#                   "STable1_HDI_intervals_figure1.png")) # File name
#   
```


<br><br>

## Figure 2: Posterior distributions

In my opinion, this is the most important figure. I decided not to use tables,
because there are too much data and Panel B and D seem to handle well this
great amount of data.

```{r}
# Create data frame

posterior_not_using = 
  samples_posteriors_not_using_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`RD`) %>% 
  rename("RD_not" = `RD`)

posterior_using = 
  samples_posteriors_using_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`RD`) %>% 
  rename("RD_u" = `RD`)

distributions_cortico_posterior =
  bind_cols(posterior_not_using,
            posterior_using)
```

```{r}
# Prepare arrows under axis
# Adapted from https://github.com/rdboyes/forester/blob/master/R/forester.R


arrow_labels = c("Tocilizumab Harm", "Tocilizumab Benefit")

xlim = c(0, 20)

xlab_df = data.frame(text = arrow_labels,
                          x = c(2,18),
                          y = c(0, 0),
                          hjust = c(0, 1))

a_small_amount = abs(xlim[1] - xlim[2])/35

null_line_at = 10

arrow_df = data.frame(id = c(1,2),
                      xstart = c(null_line_at - a_small_amount,
                                      null_line_at + a_small_amount),
                      xend = c(xlim[1] + a_small_amount, xlim[2] - a_small_amount),
                      y = c(1, 1))

arrows_plot = ggplot() +
      geom_segment(data = arrow_df,
                   aes(x = .data$xstart,
                       xend = .data$xend,
                       y = .data$y,
                       yend = .data$y),
                   arrow = arrow(angle = 15, type = "closed", length = grid::unit(0.1, "in"))) +
  geom_text(data = xlab_df,
            aes(x = .data$x,
                y = .data$y,
                label = .data$text,
                hjust = .data$hjust), size = 3.5) +
  scale_y_continuous(expand = c(0,0), limits = c(-0.5, 1.75)) +
  scale_x_continuous(expand = c(0,0), limits = xlim) +
  theme(panel.background = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.box.background = element_rect(fill = "transparent"),
        panel.border = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank())

p1 = distributions_cortico_posterior %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(RD_not:RD_u),
    names_to = "dist", values_to = "samples"
  ) %>%
  mutate(
    # Create new column to be able to use facet at the end
    subgroup = case_when(
      str_detect(dist, "_u") ~ "Using corticosteroids",
      str_detect(dist, "_not") ~ "Not using corticosteroids"
    ),

    # Set order of subgroups
    subgroup = factor(subgroup,
      levels = c(
        "Not using corticosteroids",
        "Using corticosteroids"
      )
    )) %>%
  
  # Plot!
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = 100 * samples, y = dist,
    fill = subgroup,
   # https://github.com/mjskay/ggdist/issues/71
    fill_ramp = stat(x > 0))
  ) +


  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(point_interval = median_hdi, # Highest density interval
               .width = c(0.8, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(1.1,1.9)) +
  scale_fill_ramp_discrete(from = "gray85", range = c(0,1)) +
  scale_fill_manual(values = c("#9EA45B", "#A65041")) +
  geom_vline(xintercept = 0, linetype = 2, size = 0.6) +
  labs(
    x = "\nRisk Difference (%)",
    y = " "
  ) +
  scale_x_continuous(breaks = seq(from = -10, to = 10, 2.5)) +
  coord_cartesian(xlim = c(-10, 10)) +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'none',
    plot.margin = margin(20, 10, 50, 10)
  ) +
  facet_wrap(~subgroup, ncol = 1, scales = "free_y")
```

```{r warning=FALSE, include=FALSE}
p2 = distributions_cortico_posterior %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(RD_not:RD_u),
    names_to = "dist", values_to = "samples"
  ) %>%
  mutate(
    # Create new column to be able to use facet at the end
    subgroup = case_when(
      str_detect(dist, "_u") ~ "Using corticosteroids",
      str_detect(dist, "_not") ~ "Not using corticosteroids"
    ),

    # Set order of subgroups
    subgroup = factor(subgroup,
      levels = c(
        "Not using corticosteroids",
        "Using corticosteroids"
      )
    )) %>% 
  
# Multiply by 100 to report in percentage
ggplot(aes(100 * samples, colour = subgroup)) +
  geom_line(aes(y = 1 - ..y..), stat='ecdf', size = 1.2) +
  scale_color_manual(' ',
                    values = c("#9EA45B", "#A65041")) +
  geom_vline(xintercept = 0, linetype = 2, size = 0.6) +
    labs(
      x = "\nRisk Difference (%)",
      y = "Probability RD \u2265 X\n"
      ) +
    scale_x_continuous(
      breaks = seq(from = -10, to = 10, 1),
      limits = c(-10, 10)) +
    scale_y_continuous(
      breaks = seq(from = 0, to = 1, .1),
      expand = c(0, .03)
    ) +
  theme(
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      panel.background = element_blank(),
      panel.grid.major.x = element_line(color = "gray80", size = 0.3),
      panel.grid.major.y = element_line(color = "gray80", size = 0.3),
      legend.position = 'none',
      plot.margin = margin(10, 10, 50, 10)
     ) +
  coord_cartesian(x = c(-0.1,10))
  
```


```{r}
# Create data frame

# Simple oxygen only

posterior_s = 
  samples_posteriors_simple_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`RD`) %>% 
  rename("RD_s" = `RD`)

# Non-invasive ventilation

posterior_n = 
  samples_posteriors_noninvasive_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`RD`) %>% 
  rename("RD_n" = `RD`)

# Invasive mechanical ventilation

posterior_i = 
  samples_posteriors_invasive_death %>% 
  filter(`Underlying_Prior` == "Evidence-based") %>% 
  select(`RD`) %>% 
  rename("RD_i" = `RD`)

# Bind altogether

distributions_respiratory_posterior = bind_cols(
  posterior_i,
  posterior_n,
  posterior_s
)

```

```{r}

p3 = distributions_respiratory_posterior %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(RD_i:RD_s),
    names_to = "dist", values_to = "samples"
  ) %>%
  mutate(
    # Create new column to be able to use facet at the end
    subgroup = case_when(
      str_detect(dist, "_s") ~ "Simple oxygen only",
      str_detect(dist, "_n") ~ "Non-invasive ventilation",
      str_detect(dist, "_i") ~ "Invasive mechanical ventilation"
    ),

    # Set order of subgroups
    subgroup = factor(subgroup,
      levels = c(
        "Simple oxygen only",
        "Non-invasive ventilation",
        "Invasive mechanical ventilation"
      ))
    ) %>%
  # Plot!
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = 100 * samples, y = dist,
    fill = subgroup,
    # https://github.com/mjskay/ggdist/issues/71
    fill_ramp = stat(x > 0))
  ) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
  stat_halfeye(point_interval = median_hdi, # Highest density interval
               .width = c(0.8, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(1.1,1.9)) +
  scale_fill_ramp_discrete(from = "gray85", range = c(0,1)) +
  scale_fill_manual(values = c("#9D75B1", # Simple oxygen
                               "#CE9F5B", # Non-invasive
                               "#5891BF") # Invasive
                    ) +
  geom_vline(xintercept = 0, linetype = 2, size = 0.6) +
  labs(
    x = "\nRisk Difference (%)",
    y = " "
  ) +
  scale_x_continuous(breaks = seq(from = -10, to = 10, 2.5)) +
  coord_cartesian(xlim = c(-10, 10)) +
  scale_y_discrete(expand = c(0, 0.5)) +
  theme(
    strip.background = element_rect(fill = "#E4E6E7"),
    strip.text.x = element_text(size = 12),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = 'none',
    plot.margin = margin(20, 10, 50, 10)
  ) +
  facet_wrap(~ subgroup, ncol = 1, scales = "free_y")

```

```{r warning=FALSE}
p4 = distributions_respiratory_posterior %>%
  # make it tidy for ggplot
  pivot_longer(
    cols = c(RD_i:RD_s),
    names_to = "dist", values_to = "samples"
  ) %>%
  mutate(
    # Create new column to be able to use facet at the end
    subgroup = case_when(
      str_detect(dist, "_s") ~ "Simple oxygen only",
      str_detect(dist, "_n") ~ "Non-invasive ventilation",
      str_detect(dist, "_i") ~ "Invasive mechanical ventilation"
    ),

    # Set order of subgroups
    subgroup = factor(subgroup,
      levels = c(
        "Simple oxygen only",
        "Non-invasive ventilation",
        "Invasive mechanical ventilation"
      ))
    ) %>%
# Multiply by 100 to report in percentage
ggplot(aes(100*samples, colour = subgroup)) +
  geom_line(aes(y = 1 - ..y..), stat='ecdf', size = 1.2) +
  scale_color_manual(' ',
                    values = c("#9D75B1", # Simple oxygen
                               "#CE9F5B", # Non-invasive
                               "#5891BF") # Invasive
                    ) +
  geom_vline(xintercept = 0, linetype = 2, size = 0.6) +
    labs(
      x = "\nRisk Difference (%)",
      y = "Probability RD \u2265 X\n"
      ) +
    scale_x_continuous(
      breaks = seq(from = -10, to = 10, 1),
      limits = c(-10, 10)) +
    scale_y_continuous(
      breaks = seq(from = 0, to = 1, .1),
      expand = c(0, .03)
    ) +
  theme(
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      panel.background = element_blank(),
      panel.grid.major.x = element_line(color = "gray80", size = 0.3),
      panel.grid.major.y = element_line(color = "gray80", size = 0.3),
      legend.position = 'none',
      plot.margin = margin(10, 10, 50, 10)
    ) +
  coord_cartesian(x = c(-0.1,10))
```

```{r , fig.align='center', fig.width=10, fig.height = 8.5, warning=FALSE, fig.cap="Panels A and C: Point estimates depict the median. Interval bars depict the 80% and 95% highest density intervals. Panels B and D: Cumulative posterior distributions correspond to the probabilities that the risk difference (RD) is greater than or equal to the effect size on the Xaxis."}
p1_overlay = p1 + inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(0.65, 'cm'),
                                bottom = unit(0, 'cm'),
                                right = unit(12.3, 'cm'),
                                top = unit(1.9, 'cm'))
# Plot everything



(p1_overlay + p2) / (p3 + 
                      inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(0.65, 'cm'),
                                bottom = unit(0, 'cm'),
                                right = unit(12.3, 'cm'),
                                top = unit(1.9, 'cm')) + 
                       p4) +
  plot_annotation(tag_levels = 'A')

# ggsave(width = 10,
#        height = 8.5,
#  #https://stackoverflow.com/questions/12768176/unicode-characters-in-ggplot2-pdf-output
#        device=cairo_pdf, 
#        here("final_analyses", "output", "plots", "manuscript", # File path
#                  "figure2.pdf")) # File name
```

<br><br>

```{r}
multiply100 = function(x){x*100}

t1 = distributions_cortico_posterior %>%
  # make it tidy to be able to use group_by()
  pivot_longer(
    cols = c(RD_not:RD_u),
    names_to = "Subgroup", values_to = "samples"
  ) %>% 
  group_by(Subgroup) %>% 
  summarise("Pr(\u2265 0%)" = (sum( samples >= 0))/ n(),
            "Pr(\u2265 1%)" = (sum( samples >= 0.01))/ n(),
            "Pr(\u2265 2%)" = (sum( samples >= 0.02))/ n(),
            "Pr(\u2265 5%)" = (sum( samples >= 0.05))/ n()) %>% 
  mutate(across(-Subgroup, ~multiply100(.))) %>% 
  mutate(across(-Subgroup, ~round(.,1))) %>% 
  mutate(
    Subgroup = case_when(
      str_detect(Subgroup, "_u") ~ "Using",
      str_detect(Subgroup, "_not") ~ "Not using"
    ))

```


```{r}
multiply100 = function(x){x*100}
t2 = distributions_cortico_posterior %>% 
  # make it tidy to be able to use group_by()
  pivot_longer(
    cols = c(RD_not:RD_u),
    names_to = "Subgroup", values_to = "samples"
  ) %>% 
  # Group by distribution so we can apply median_hdi
  group_by(Subgroup) %>% 
  # Calculate the median and 95% quantile interval in log-odds ratio
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  select(Subgroup:.upper) %>%
  mutate(across(samples:.upper, ~multiply100(.))) %>%
  mutate(across(samples:.upper, ~round(., 2))) %>%
  rename("Median" = samples,
         "Upper limit" = .upper,
         "Lower limit" = .lower) %>% 
  mutate(
    Subgroup = case_when(
      str_detect(Subgroup, "_u") ~ "Using",
      str_detect(Subgroup, "_not") ~ "Not using"
    ))
```

```{r}
multiply100 = function(x){x*100}

t3 = distributions_respiratory_posterior %>%
  # make it tidy to be able to use group_by()
  pivot_longer(
    cols = c(RD_i:RD_s),
    names_to = "Subgroup", values_to = "samples"
  ) %>% 
  group_by(Subgroup) %>% 
  summarise("Pr(\u2265 0%)" = (sum( samples >= 0))/ n(),
            "Pr(\u2265 1%)" = (sum( samples >= 0.01))/ n(),
            "Pr(\u2265 2%)" = (sum( samples >= 0.02))/ n(),
            "Pr(\u2265 5%)" = (sum( samples >= 0.05))/ n()) %>% 
  mutate(across(-Subgroup, ~multiply100(.))) %>% 
  mutate(across(-Subgroup, ~round(.,1))) %>%
  arrange(desc(Subgroup)) %>% 
  mutate(
    Subgroup = case_when(
      str_detect(Subgroup, "_s") ~ "Simple oxygen only",
      str_detect(Subgroup, "_n") ~ "Non-invasive ventilation",
      str_detect(Subgroup, "_i") ~ "Invasive mechanical ventilation"
    ))

```

```{r}
multiply100 = function(x){x*100}

t4 = distributions_respiratory_posterior %>% 
  # make it tidy to be able to use group_by()
  pivot_longer(
    cols = c(RD_i:RD_s),
    names_to = "Subgroup", values_to = "samples"
  ) %>% 
  # Group by distribution so we can apply median_hdi
  group_by(Subgroup) %>% 
  # Calculate the median and 95% quantile interval in log-odds ratio
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  select(Subgroup:.upper) %>%
  mutate(across(samples:.upper, ~multiply100(.))) %>%
  mutate(across(samples:.upper, ~round(., 2))) %>%
  rename("Median" = samples,
         "Upper limit" = .upper,
         "Lower limit" = .lower) %>% 
  arrange(desc(Subgroup)) %>% 
  mutate(
    Subgroup = case_when(
      str_detect(Subgroup, "_s") ~ "Simple oxygen only",
      str_detect(Subgroup, "_n") ~ "Non-invasive ventilation",
      str_detect(Subgroup, "_i") ~ "Invasive mechanical ventilation"
    ))
```

```{r}
table_rd = bind_rows(t1,t3) 

table_prob = bind_rows(t2,t4)

tfinal = left_join(table_prob, table_rd) %>% 
  gt() %>% 
  tab_spanner(label = "95% Highest Density Interval",
              columns = 2:4) %>% 
  tab_spanner(label = "Probability of Risk Difference \u2265 X%",
              columns = 5:8) %>% 
  tab_row_group(
    label = "Respiratory support",
    rows = 3:5
  ) %>% 
  tab_row_group(
    label = "Use of corticosteroids",
    rows = 1:2
  ) %>%
  
  cols_align(
    align = "center",
    columns = everything()
  ) 

tfinal

# tfinal %>% 
#   gtsave(here("final_analyses", "output", "plots", "appendix", # File path
#                   "STable2_hdi_probabilities_figure2.png")) # File name
  
```


<br><br>

## Figure 3: Posterior distributions; Sensitivity analysis of "invasive mechanical ventilation"

This sensitivity analysis are the ones with the greatest change across priors.
These changes can actually interfer clinical decision. Thus, I judged that these
analyses "deserve" their own figure. 

```{r, , fig.align='center', fig.width=7, fig.height = 4.5, fig.cap="Point estimates depict the median. Interval bars depict the 50 and 95% highest density intervals."}

level_order = c("Pessimistic",
                "Optimistic",
                "Skeptical",
                "Non-informative",
                "Evidence-based")

p1 = samples_posteriors_invasive_death %>%
  
  ggplot(aes(
    # Multiply by 100 to report in percentage
    x = 100 * RD,
    y = factor(`Underlying_Prior`, level = level_order),
    fill = `Underlying_Prior`)) +

  # https://mjskay.github.io/ggdist/articles/slabinterval.html
    stat_halfeye(aes(fill = stat(x > 0)),
                 position = "dodge",
               point_interval = median_hdi, # Highest density interval
               .width = c(0.8, 0.95),
               # https://github.com/mjskay/ggdist/issues/70
               interval_size_range = c(1.1,1.9)
  ) +
  scale_fill_manual(values = c("gray85", "#5891BF")) +
  labs(x = "\nRisk Difference (%)",
       y = "Underlying Prior\n"
  ) +
  scale_x_continuous(breaks = seq(from = -10, to = 10, 2.5)) +
  scale_y_discrete(expand = c(0, 0.3)) +
  theme(axis.title.x = element_text(size = 11.5),
    axis.title.y = element_text(size = 12),
    axis.text.y = element_text(size = 11),
    axis.text.x = element_text(size = 11),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    legend.position = "none",
    plot.title.position = 'plot',
    plot.margin = margin(20, 25, 45, 20)
  ) +
  coord_cartesian(xlim = c(-10, 11))

p1_overlay = p1 + inset_element(arrows_plot,
                                ignore_tag = TRUE,
                                align_to = "full",
                                left = unit(4.5, 'cm'),
                                bottom = unit(0, 'cm'),
                                right = unit(16.15, 'cm'),
                                top = unit(1.6, 'cm'))

p1_overlay

# ggsave(width = 7,
#        height = 4.5,
#        here("final_analyses", "output", "plots", "manuscript", # File path
#                   "figure3.pdf")) # File name
```

<br><br>

Here are the 95% HDI in *risk difference* of each distribution.

```{r}
multiply100 = function(x){x*100}

samples_posteriors_invasive_death %>%
  select("Underlying_Prior", "RD") %>% 
  # Group by distribution so we can apply median_hdi
  group_by(`Underlying_Prior`) %>% 
  # Calculate the median and 95% quantile interval in log-odds ratio
  ggdist::median_hdi(.width = 0.95) %>% 
  # Select only the relevant columns
  # Arrange order
  arrange(factor(`Underlying_Prior`, levels = c(
    "Non-informative",
    "Evidence-based",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
    ))) %>% 
  select("Underlying_Prior":.upper) %>%
  mutate(across(RD:.upper, ~multiply100(.))) %>%
  mutate(across(RD:.upper, ~round(., 2))) %>%
  rename("Underlying Prior" = Underlying_Prior,
         "Median" = RD,
         "Upper limit" = .upper,
         "Lower limit" = .lower) %>% 
  kbl(booktabs = T, align = 'c') %>% 
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  add_header_above(c(" " = 1,
                     "95% Highest Density Interval" = 3))
```

<br><br>

## Table 2: Posterior distributions; Sensitivity analysis of "invasive mechanical ventilation"

This table complements Figure 3.

```{r}

t = tibble(
  
  "Underlying Prior" = c(
    "Non-informative",
    "Evidence-based",
    "Skeptical",
    "Optimistic",
    "Pessimistic"
  ),
  
  
  "Pr(< -5%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.05) / n()) %>%
                           pull()), 2) * 100
                  ),
  
  "Pr(< -2%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.02) / n()) %>%
                           pull()), 2) * 100
                  ),
  
  "Pr(< -1%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD < -0.01) / n()) %>%
                           pull()), 2) * 100
                  ),
  
  
  "Pr(> 0%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD > 0) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD > 0) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD > 0) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD > 0) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD > 0) / n()) %>%
                           pull()), 2) * 100
                  ),
  
  "Pr(> 1%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD > 0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD > 0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD > 0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD > 0.01) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD > 0.01) / n()) %>%
                           pull()), 2) * 100
                  ),
  
  "Pr(> 2%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD > 0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD > 0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD > 0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD > 0.02) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD > 0.02) / n()) %>%
                           pull()), 2) * 100
                  ),
  
  "Pr(> 5%)" = c(round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Non-informative") %>%
                           summarise(n = sum(RD > 0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Evidence-based") %>%
                           summarise(n = sum(RD > 0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Skeptical") %>%
                           summarise(n = sum(RD > 0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Optimistic") %>%
                           summarise(n = sum(RD > 0.05) / n()) %>%
                           pull()), 2) * 100,
                  
                  round((samples_posteriors_invasive_death %>%
                           filter(`Underlying_Prior` == "Pessimistic") %>%
                           summarise(n = sum(RD > 0.05) / n()) %>%
                           pull()), 2) * 100
                  )
)

# https://stackoverflow.com/questions/26548495/reorder-rows-using-custom-order

level_order = c("Evidence-based",
                "Non-informative",
                "Skeptical",
                "Optimistic",
                "Pessimistic"
                )

t = t %>% 
  slice(match(level_order, `Underlying Prior`))


t = t %>%
  gt() %>% 
  tab_spanner(label = "Propability of Harm",
              columns = c("Pr(< -5%)", "Pr(< -2%)", "Pr(< -1%)")) %>% 
  tab_spanner(label = "Probability of Benefit",
              columns = c("Pr(> 0%)", "Pr(> 1%)", "Pr(> 2%)", "Pr(> 5%)")) %>% 
  cols_align(
    align = "center",
    columns = everything()
  ) 

t

# t %>% 
#   gtsave(here("final_analyses", "output", "plots", "manuscript", # File path
#                   "table2.png"))
```

