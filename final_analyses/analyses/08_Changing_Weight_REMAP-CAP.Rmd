---
title: "08_Changing_Weight_REMAP-CAP"
author: "Arthur M. Albuquerque"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
          code_folding: hide
          toc: yes
          toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
# Ensures the package "pacman" is installed
if (!require("pacman")) install.packages("pacman")

# p_load() installs (if necessary) and loads the following packages

pacman::p_load(rio, # to import/export files
               tidyverse, # Data wrangling and plotting
               flextable, # To create tables
               here, # To find file paths within R project
               metafor, # To create priors from meta-analysis
               janitor, # To improve column's name
               Hmisc, # To use %nin%
               ggdist, # To plot distributions
               patchwork # To arrange plots
               )

```

```{r}

d = import(here("final_analyses", "data", # file path
                            "corticosteroids_subgroup_extracted-data.xlsx")) 

d = clean_names(d)
```

**In this document, we will discuss the rationale underlying the data on use of corticosteroids from the REMAP-CAP trial (mortality outcome). We also showed the details about it in our Supplementary Material.**

Regarding the REMAP-CAP study, we extracted data on corticosteroid subgroups from
Figure 9 in their appendix. Unfortunately, the authors don't provide raw number
of events in each subgroup. Thus, we used the [{juicr}
package](https://cran.r-project.org/web/packages/juicr/index.html) to extract
data directly from Figure 9. The raw data and extraction report generated by
{juicr} can be found in the "final\_analyses/data" folder in my
[GitHub](https://github.com/arthur-albuquerque/tocilizumab_reanalysis).

<br>

Of note, REMAP-CAP is a three-arm randomized controlled trial that tested
tocilizumab and sarilumab (both are IL-6 antagonist) vs. usual care. The authors
only provided pooled data from these IL-6 antagonists vs. usual care in
Figure 9. Thus, we decided to analyze data on corticosteroid subgroups from
REMAP-CAP with different weights: 100%, 75% and 50%. In this way, the
numbers of events and sample sizes are multiplied by 1, 0.75 or 0.5,
respectively. These different weights will directly reflect on the variance of
the prior distribution, increasing its uncertainty.

Here are the original (100% weight) number of events and sample sizes from the
REMAP-CAP trial:

```{r}
d %>% 
  filter(trial == "REMAP-CAP") %>% 
  select(trial:total_control) %>% 
  flextable() %>% 
  autofit()
```

Now with 75% weight:

```{r}
# Create custom function
multiply75 = function(x){x*0.75}

remap75 = d %>% 
  filter(trial == "REMAP-CAP") %>% 
  # Multiply columns regarding events and sample size using custom function
  mutate(across(events_toci:total_control, ~ multiply75(.))) %>% 
  # Re-calculate "diff" columns with 75% weight data
  mutate(diff_toci = total_toci - events_toci,
         diff_control = total_control - events_control) %>% 
  # Change name of the trial
  mutate(trial = "75% REMAP-CAP")

remap75 %>% 
  flextable() %>%
  autofit()
```

Now with 50% weight:

```{r}
# Create custom function
multiply50 = function(x){x*0.50}

remap50 = d %>% 
  filter(trial == "REMAP-CAP") %>% 
  # Multiply columns regarding events and sample size using custom function
  mutate(across(events_toci:total_control, ~ multiply50(.))) %>% 
  # Re-calculate "diff" columns with 50% weight data
  mutate(diff_toci = total_toci - events_toci,
         diff_control = total_control - events_control) %>% 
  # Change name of the trial
  mutate(trial = "50% REMAP-CAP")
  
remap50 %>%   
  flextable() %>%
  autofit()
```
Now let's add this data as new rows in our data frame:

```{r}
d = d %>% 
  bind_rows(remap75, remap50)

d %>%
  distinct(trial) %>% 
  flextable() %>% 
  autofit()
```

## Mortality outcome

### Using REMAP-CAP with 100% weight

#### Using corticosteroids

Let's start the data wrangling

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_100_using_cortico_data_death =
  d %>%
  # Remove rows using different weights on REMAP-CAP
  filter(str_detect(trial, "%", negate = TRUE)) %>% 
  filter(
    trial != "RECOVERY", # Not RECOVERY
    corticosteroids == 1 # Using corticosteroids
  )

priors_100_using_cortico_death =
  rma(
    # Outcome
    measure = "OR", # Log-odds ratio
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_100_using_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_100_using_cortico_death,
       showweights = T,
       refline     = 0)

```

#### Not using corticosteroids

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_100_not_cortico_data_death =
  d %>%
  # Remove rows using different weights on REMAP-CAP
  filter(str_detect(trial, "%", negate = TRUE)) %>% 
  filter(
    trial != "RECOVERY", # Not RECOVERY
    corticosteroids == 0 # Not using corticosteroids
  )

priors_100_not_cortico_death =
  rma(
    # Outcome
    measure = "OR", # Log-odds ratio
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_100_not_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_100_not_cortico_death,
       showweights = T,
       refline     = 0)

```

### Using REMAP-CAP with 75% weight

#### Using corticosteroids

Let's start the data wrangling

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_75_using_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "50% REMAP-CAP"), # Not 50%
    corticosteroids == 1 # Using corticosteroids
  )

priors_75_using_cortico_death =
  rma(
    # Outcome
    measure = "OR", # Log-odds ratio
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_75_using_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_75_using_cortico_death,
       showweights = T,
       refline     = 0)

```

#### Not using corticosteroids

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_75_not_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "50% REMAP-CAP"), # Not 50%
    corticosteroids == 0 # Not using corticosteroids
  )

priors_75_not_cortico_death =
  rma(
    # Outcome
    measure = "OR", # Log-odds ratio
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_75_not_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_75_not_cortico_death,
       showweights = T,
       refline     = 0)

```

### Using REMAP-CAP with 50% weight

#### Using corticosteroids

Let's start the data wrangling

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_50_using_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "75% REMAP-CAP"), # Not 75%
    corticosteroids == 1 # Using corticosteroids
  )

priors_50_using_cortico_death =
  rma(
    # Outcome
    measure = "OR", # Log-odds ratio
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_50_using_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_50_using_cortico_death,
       showweights = T,
       refline     = 0)

```
#### Not using corticosteroids

```{r, fig.align='center', fig.height=4, fig.width=7}

priors_50_not_cortico_data_death =
  d %>% 
  filter(
    trial %nin% c("RECOVERY", # Not RECOVERY /// %nin% from the {Hmisc} package
    "REMAP-CAP", # Not 100% weight
    "75% REMAP-CAP"), # Not 75%
    corticosteroids == 0 # Not using corticosteroids
  )

priors_50_not_cortico_death =
  rma(
    # Outcome
    measure = "OR", # Log-odds ratio
    
    # Tocilizumab group
    ai = events_toci,
    n1i = total_toci,

    # Control group
    ci = events_control,
    n2i = total_control,
    
    data = priors_50_not_cortico_data_death %>% filter(outcome == "mortality"),

    slab = paste(trial),
    method = "REML"
  )

forest(priors_50_not_cortico_death,
       showweights = T,
       refline     = 0)

```

### Summary

**In conclusion, the prior distributions are very similar regardless of the weight used for REMAP-CAP.**

```{r}

# https://mjskay.github.io/ggdist/articles/slabinterval.html
set.seed = 123

n = 10e4

d = tibble("100%" = rnorm(n,
                      mean = priors_100_using_cortico_death$beta,
                      sd = priors_100_using_cortico_death$se),
       "75%" = rnorm(n,
                      mean = priors_75_using_cortico_death$beta,
                      sd = priors_75_using_cortico_death$se),
       "50%" = rnorm(n,
                      mean = priors_50_using_cortico_death$beta,
                      sd = priors_50_using_cortico_death$se),
) %>% 
  pivot_longer(everything(),
               names_to = "Weight",
               values_to = "samples") %>% 
  mutate(Weight = factor(Weight,
                         levels = c("100%", "75%", "50%")))
log_using =  d %>% 
  ggplot(aes(fill = Weight, color =  Weight, x = samples)) + 
  stat_pointinterval(position = position_dodge(width = .7, preserve = "single"),
                     point_interval = median_hdi, # HDI
                     # Little trick to preserve the width = .7 above
                     .width = c(0.94999, 0.95)) +
  stat_slab(alpha = 0.3) +
  labs(x = "\nLog-Odds Ratio",
       y = " ",
       title = "Using corticosteroids\n") +
  scale_x_continuous(breaks = seq(-1, 1, 0.25)) +
  scale_y_continuous(breaks = NULL) +
  theme(
    legend.position = 'none',
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    plot.margin = margin(20, 20, 0, 20)
  ) +
    coord_cartesian(x = c(-1.2,1))

exp_using =  d %>% 
  ggplot(aes(fill = Weight, color =  Weight, x = exp(samples))) + 
  stat_pointinterval(position = position_dodge(width = .7, preserve = "single"),
                     point_interval = median_hdi, # HDI
                     # Little trick to preserve the width = .7 above
                     .width = c(0.94999, 0.95)) +
  stat_slab(alpha = .3) +
  labs(x = "\nOdds Ratio",
       y = " ") +
  scale_x_continuous(breaks = seq(0, 2, 0.25)) +
  scale_y_continuous(breaks = NULL) +
  theme(
    legend.position = 'none',
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    plot.margin = margin(20, 20, 0, 20)
  ) +
    coord_cartesian(x = c(0.25,2))
```

```{r}
set.seed = 123

n = 10e4

d = tibble("100%" = rnorm(n,
                      mean = priors_100_not_cortico_death$beta,
                      sd = priors_100_not_cortico_death$se),
       "75%" = rnorm(n,
                      mean = priors_75_not_cortico_death$beta,
                      sd = priors_75_not_cortico_death$se),
       "50%" = rnorm(n,
                      mean = priors_50_not_cortico_death$beta,
                      sd = priors_50_not_cortico_death$se),
) %>% 
  pivot_longer(everything(),
               names_to = "Weight",
               values_to = "samples") %>% 
  mutate(Weight = factor(Weight,
                         levels = c("100%", "75%", "50%")))
log_not =  d %>% 
  ggplot(aes(fill = Weight, color =  Weight, x = samples)) + 
  stat_pointinterval(position = position_dodge(width = .7, preserve = "single"),
                     point_interval = median_hdi, # HDI
                     # Little trick to preserve the width = .7 above
                     .width = c(0.94999, 0.95)) +

  stat_slab(alpha = .3) +
  labs(x = "\nLog-Odds Ratio",
       y = " ",
       title = "Not using corticosteroids\n") +
  scale_x_continuous(breaks = seq(-1, 1, 0.25)) +
  scale_y_continuous(breaks = NULL) +
  theme(
    legend.position = 'none',
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    plot.margin = margin(20, 20, 5, 20)
  ) +
    coord_cartesian(x = c(-1.2,1))

exp_not =  d %>% 
  ggplot(aes(fill = Weight, color =  Weight, x = exp(samples))) + 
  stat_pointinterval(position = position_dodge(width = .7, preserve = "single"),
                     point_interval = median_hdi, # HDI
                     # Little trick to preserve the width = .7 above
                     .width = c(0.94999, 0.95)) +
  stat_slab(alpha = .3) +
  labs(x = "\nOdds Ratio",
       y = " ") +
  scale_x_continuous(breaks = seq(0, 2, 0.25)) +
  scale_y_continuous(breaks = NULL) +
  theme(
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.x = element_line(color = "gray80", size = 0.3),
    plot.margin = margin(20, 20, 5, 0)
  ) +
    coord_cartesian(x = c(0.25,2))

(log_not + exp_not) / (log_using + exp_using)


# ggsave(width = 11,
#       height = 6,
#        here("final_analyses", "output", "plots", "appendix", # file path
#             "weight_remap_cap_corticosteroids.pdf"))

```
