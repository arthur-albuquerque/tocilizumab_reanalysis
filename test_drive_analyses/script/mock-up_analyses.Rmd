---
title: "other-trial_mock-up"
author: "Arthur"
date: "4/14/2021"
output: html_document
---

```{r echo=FALSE}
library(tidyverse)
library(kableExtra)
library(flextable)
```

## Inspiration
This was inspired by Brophy 2020

#### Enter data

```{r}
# Placebo_death = totality mortality in control group
# TA_death = totality mortality in intervention 
# Placebo_n = number of subjects in control group
# TA_n = number of subjects in intervention group

data = 
  tibble(
    study = c("CRASH-2 (2011)", "Yut et al (2013)", "NCT (2019)", "CRASH-3 (2019)"),
    placebo_death = c(24, 18, 50, 525),
    placebo_n = c(137, 120, 285, 3757),
    TA_death = c(14, 12, 93, 485),
    TA_n = c(133, 120, 603, 3880)
  ) %>% 
  mutate(placebo_diff = placebo_n - placebo_death,
         TA_diff      = TA_n - TA_death)

data %>% 
  kable(caption="Evidence on the effect of tranexamic acid on head injury-related death") %>%
  kable_styling(bootstrap_options = "striped", full_width = T)

# write.csv(data, file = "/Users/arthur/Coding/projects/CRASH-3_reanalyses/output/data/original_data.csv", row.names = FALSE)
```
## CRASH-3 data alone

### Primary outcome difference
Bayesian probability difference based on non-informative prior

```{r}

set.seed(1234)

##### CRASH-3 data
CRASH_3_data = 
  data %>% 
  filter(study == "CRASH-3 (2019)")


# Sampling 100,000 random variables from posterior
sampling_size = 1e5


posterior_CRASH_3_data = 
  
  CRASH_3_data %>% 
  
  summarise(post_placebo_death = list(rbeta(sampling_size, placebo_death + 1, placebo_diff + 1)), # Prior is beta(1,1)
            post_TA_death      = list(rbeta(sampling_size, TA_death + 1, TA_diff + 1))) %>%  # Prior is beta(1,1)
  unnest(cols = c(post_TA_death, post_placebo_death)) %>%
  
  summarise(p_grid = seq(from = 0, to = 1, length.out = sampling_size),
            post_diff = post_placebo_death - post_TA_death)


```

```{r}
# Calculating posterior of differences
paste("CRASH-3 data alone - Differences in head injury-related death between control and tranexamic acid")
mode_hdi(posterior_CRASH_3_data$post_diff,
        .width = c(.5, .8, .95)) %>% 
  select(.point, y, .width, ymin, ymax)

```

```{r}
# Plot!
p_grid = seq(0, 1, 0.005)

a_crash = data[4,4] %>% pull()
b_crash = (data[4,5] - data[4,4]) %>% pull()

p_grid = seq(0, 1, 0.005)

df_posterior = tibble(
                    p_grid,
                    prior = 1,
                    likelihood = dbeta(p_grid, a_crash, b_crash),
                    posterior = (prior*likelihood)/sum(prior*likelihood)
                    )

samples = df_posterior %>% 
  slice_sample(n = 10e4, weight_by = posterior, replace = T)

p1 = df_posterior %>% 
  ggplot(aes(x = p_grid, y = posterior)) +
  geom_line() +
  lims(x = c(0.05, 0.15)) +
  geom_area(data = df_posterior %>%
              filter(
                p_grid > hdi(df_posterior$p_grid, .width = .5)[1] &
                p_grid < hdi(df_posterior$p_grid, .width = .5)[2]),
            fill = "grey75")

p2 = samples %>% 
  ggplot(aes(x = p_grid, y = posterior)) +
  geom_line() +
  lims(x = c(0.05, 0.15)) +
  geom_area(data = df_posterior %>%
              filter(
                p_grid > hdi(df_posterior$p_grid, .width = .5)[1] &
                p_grid < hdi(df_posterior$p_grid, .width = .5)[2]),
            fill = "grey75")

p3 = samples %>% 
  mutate(n = 1:n()) %>% 
  
  ggplot(aes(x = n, y = p_grid)) +
  geom_point()

p4 = samples %>% 
  ggplot(aes(x = p_grid)) +
  geom_density()

p1 + p2 + p3 + p4
```

```{r}
control_grid = tibble(p_grid = seq(from = 0, to = 1, length.out = 10000),
                    prior = dbeta(p_grid, 1, 1),
                    likelihood = dbinom(525, size = 3757, prob = p_grid), 
                    posterior = (likelihood * prior) / sum(likelihood * prior))

ta_grid = tibble(p_grid = seq(from = 0, to = 1, length.out = 10000),
                    prior = dbeta(p_grid, 1, 1),
                    likelihood = dbinom(485, size = 3880, prob = p_grid), 
                    posterior = (likelihood * prior) / sum(likelihood * prior))

p1 = control_grid %>% 
    slice_sample(n = 1e4, weight_by = posterior, replace = TRUE) %>% 
    ggplot(aes(x = p_grid, y = posterior)) +
    geom_line() + 
    geom_area(data = control_grid %>% filter(p_grid < 0.14)) + 
    lims(x = c(0.1, 0.2))
  

p2 = ta_grid %>% 
    slice_sample(n = 1e4, weight_by = posterior, replace = TRUE) %>% 
    ggplot(aes(x = p_grid, y = posterior)) +
    geom_line() +
    geom_area(data = ta_grid %>% filter(p_grid < 0.14))+ 
    lims(x = c(0.1, 0.2))
  
library(patchwork)
p1 + p2
```
```{r}
diff_grid = tibble(
  
)
```


### Function for congugate normal analyses

Given the large sample sizes the distributions can be approximated as normal.    
Here is a function that takes the prior and likelihood risk differences, both expressed as a mean and variance, and combines them in a conjugate normal analysis to get the posterior distributions.

```{r}
post.normal.mean <- function(data.mean, data.var, prior.mean, prior.var)
{
####################################################################
#  R function for Bayesian analysis of normal mean, variance known #
#  Parameters included are:                                        #
#                                                                  #
#  Inputs:                                                         #
#                                                                  #
#   x = vector of data                                             #
#   prior.mean = prior mean                                        #
#   prior.var  = prior variance                                    #
#   data.var   = assumed known variance of data                    #
#                                                                  #
#  Outputs:                                                        #
#                                                                  #
#   post.mean = posterior mean                                     #
#   post.var  = posterior variance                                 #
#                                                                  #
####################################################################

post.mean.numerator <- prior.mean/prior.var + data.mean/data.var
post.mean.denominator <- 1/prior.var + 1/data.var
post.mean <-  post.mean.numerator/post.mean.denominator
post.var <- (1/(1/prior.var + 1/data.var))
a <- "Post mean = "
b <- "Post Var = "
c <- "Post SD = "
cat(a, post.mean, ",", b, post.var, ",", c, sqrt(post.var), "\n" )
newlist <- list(post.mean, post.var, sqrt(post.var))
return(newlist)
}

```

### Primary outcome using prior information    

#### Random effects model of previous studies

We now use estimates of effect size and the variance of the 3 previous studies obtained under a random effects model which includes both the within and between study variances.     
We will combine this prior information with the EXCEL data using the congugate normal function defined previously. 

```{r}
# prior primary outcome, random effects model for the risk differences
prior = 
  data %>% 
  filter(study != "CRASH-3 (2019)")

RD_re = rma(ai= placebo_death, n1i= placebo_n,
             ci= TA_death, n2i=TA_n,
             data=prior, measure="RD",
             slab=paste(study), method="REML")

forest(RD_re)


# from above rma function 
prior_table =
  tibble(prior_mean = RD_re$beta,
         prior_sd   = RD_re$se)
```

#### Combining CRASH-3 with prior information

```{r}
# same procedure for the CRASH-3 data (likelihood)
likelihood_CRASH_3 = 
  data %>% 
  filter(study == "CRASH-3 (2019)") %>% 
  summarise(TA_ratio_mean      = TA_death/TA_n,
            placebo_ratio_mean = placebo_death / placebo_n,
            diff_ratio_mean    = placebo_ratio_mean - TA_ratio_mean,
            TA_variance        = TA_ratio_mean * (1 - TA_ratio_mean) / TA_n,
            TA_sd              = sqrt(TA_variance),
            placebo_variance   = placebo_ratio_mean * (1 - placebo_ratio_mean) / placebo_n,
            placebo_sd         = sqrt(placebo_variance),
            diff_variance      = TA_sd^2 + placebo_sd^2,
            diff_sd            = sqrt(diff_variance))
  
CRASH_3_and_prior =
  prior_table %>% 
  bind_cols(likelihood_CRASH_3)

# CRASH-3 primary outcome + random effects model of previous studies combined with normal conjugacy
CRASH_3_mean = 
  CRASH_3_and_prior %>% 
  pull(diff_ratio_mean)

CRASH_3_var = 
  CRASH_3_and_prior %>% 
  pull(diff_variance)

prior_mean = 
  CRASH_3_and_prior %>% 
  pull(prior_mean)

prior_var = 
  CRASH_3_and_prior %>% 
  pull(prior_sd)

post_primary = post.normal.mean(CRASH_3_mean, CRASH_3_var, prior_mean, (prior_var^2))

```
#### Triplot for primary outcome Figure 2a

```{r}
#df <- data.frame(100*rbind(c(prior.diff.prim.mean, prior.diff.prim.sd), c(like.diff.prim.mean, like.diff.prim.sd), c(post.primary[[1]], post.primary[[3]])))
#df$type <- c("Prior", "EXCEL", "Posterior")
#df <- df %>%
#  rename(mean = X1, se = X2)

fig2a = ggplot(data.frame(x = c(-3, 9)), aes(x = x)) +
        stat_function(fun = dnorm,                          # Prior
                      args = list(prior_mean*100,
                                  prior_var*100),
                      colour = "#364d55") +
        stat_function(fun = dnorm,                          # Likelihood
                      args = list(CRASH_3_mean*100,
                                  sqrt(CRASH_3_var)*100),
                      colour = "#df8f43") +
        stat_function(fun = dnorm,                          # Posterior
                      args = list(post_primary[[1]]*100,
                                  post_primary[[3]]*100),
                      colour = "#00a0d5") +
        annotate(
           geom = "curve",
           x = -1.7, y = 0.40,
           xend = 0.5, yend = 0.35, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
        annotate(geom = "text",
                 x = -2.5, y = 0.43, label = "CRASH-3", hjust = "left") +
        annotate(
           geom = "curve",
           x = 7, y = 0.23,
           xend = 5.8, yend = 0.18, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
        annotate(geom = "text",
                 x = 7.2, y = 0.24, label = "Prior", hjust = "left") +
        annotate(
           geom = "curve",
           x = 4.5, y = 0.5,
           xend = 2.6, yend = 0.41, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
        annotate(geom = "text",
                 x = 4.7, y = 0.5, label = "Posterior", hjust = "left") +
        scale_x_continuous(breaks = c(-3,0,3,6,9),
                           expand = c(0,0)) +
        scale_y_continuous(expand = c(0,0)) +
        ggtitle("Effect of tranexamic acid on death in patients with acute traumatic brain injury \n(CRASH-3 and previous evidence)\n") +
        xlab ("Difference in mortality between placebo and tranexamic acid (%)") +
        ylab ("Density") +
        theme_classic() +
        theme(plot.margin = margin(15, 15, 15, 15),
        plot.title.position = 'plot')
        

fig2a
```
### Calculating posterior probability
```{r}
#paste("Posterior data - Probability that tranexamic acid reduces mortality = ",
  #    round(1-pnorm(0, post_primary[[1]], post_primary[[3]]),2))

#paste("Posterior data - Probability that tranexamic acid reduces mortality by 1% = ",
  #    round(0.8-pnorm(0, post_primary[[1]], post_primary[[3]]),2))

paste(" Posterior mean", round(post_primary[[1]]*100,2))

paste("89% Credible interval:", round(post_primary[[1]]*100 - 1.60 * post_primary[[3]]*100,2), " - ", round(post_primary[[1]]*100 + 1.60 * post_primary[[3]]*100,2))  
```


## Plotting the posterior distribution

```{r}
fig3 = 
  ggplot(data.frame(x = c(-1, 5)), aes(x = x)) +
  stat_function(fun = dnorm,
                args = list(post_primary[[1]]*100,
                       post_primary[[3]]*100)) +
  geom_vline(xintercept = mean(post_primary[[1]]*100)) +
  stat_function(fun = dnorm,
                args = list(post_primary[[1]]*100,
                       post_primary[[3]]*100),
                xlim = c(0.63,2.94),
                geom = "area",
                alpha = 0.5,
                fill = "#675aa6") +
  annotate("text",
           label = "Mean posterior difference = 1.80%",
           x = 3.6,
           y = .47,
           color = "black") +
  annotate("text",
           label = "89% Credible interval: [0.63, 2.94]",
           x = 3.6,
           y = .43,
           color = "black") +
  scale_x_continuous(name = "Difference in mortality between placebo and tranexamic acid (%)",
                     breaks = c(-2:6),
                     expand=c(0,0)) +
  scale_y_continuous(name = "Density",
                     expand=c(0,0)) +
  ggtitle("Effect of tranexamic acid on death in patients with acute traumatic brain injury") +
  labs(subtitle = "Posterior probability of CRASH-3 + previous evidence\n") +
  theme_classic() +
  theme(plot.margin = margin(20, 25, 20, 25),
        plot.title.position = 'plot')

fig3
```